;; 09-log-analysis.qi - ãƒ­ã‚°è§£æãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
;;
;; Unixã‚³ãƒãƒ³ãƒ‰ + Qiãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ = å¼·åŠ›ãªãƒ­ã‚°è§£æãƒ„ãƒ¼ãƒ«
;; å®Ÿè¡Œ: qi examples/09-log-analysis.qi

(println "=== ãƒ­ã‚°è§£æãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ ===\n")

;; ã‚µãƒ³ãƒ—ãƒ«ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
(println "=== ã‚µãƒ³ãƒ—ãƒ«ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ä½œæˆ ===")

(def sample-log "
2025-01-20 10:00:01 INFO User login: alice
2025-01-20 10:00:15 ERROR Database connection failed
2025-01-20 10:00:30 INFO User login: bob
2025-01-20 10:01:00 WARN Slow query detected: SELECT * FROM users
2025-01-20 10:01:15 ERROR API timeout: /api/users
2025-01-20 10:02:00 INFO User logout: alice
2025-01-20 10:02:30 INFO User login: charlie
2025-01-20 10:03:00 ERROR Database connection failed
2025-01-20 10:03:15 WARN Memory usage: 85%
2025-01-20 10:04:00 INFO User logout: bob
")

;; ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
(io/write-file "/tmp/app.log" sample-log)
(println "ã‚µãƒ³ãƒ—ãƒ«ãƒ­ã‚°ã‚’ /tmp/app.log ã«ä½œæˆã—ã¾ã—ãŸ")

;; ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã”ã¨ã®é›†è¨ˆ
(println "\n=== ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã”ã¨ã®é›†è¨ˆ ===")

(def log-content (io/read-file "/tmp/app.log"))

(defn extract-log-level [line]
  (let [parts (str/split line " ")]
    (if (>= (len parts) 3)
      (nth parts 2)
      "UNKNOWN")))

(println (log-content
          |> (str/split "\n")
          |> (filter (fn [s] (> (len s) 0)))
          |> (map extract-log-level)
          |> (group-by identity)
          |> (map (fn [[level lines]] [level (len lines)]))))

;; ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã ã‘æŠ½å‡º
(println "\n=== ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°æŠ½å‡º ===")

(println (log-content
          |> (str/split "\n")
          |> (filter (fn [line] (str/includes? line "ERROR")))
          |> (str/join "\n")))

;; æ™‚é–“å¸¯åˆ¥ã®çµ±è¨ˆ
(println "\n=== æ™‚é–“å¸¯åˆ¥ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ ===")

(defn extract-hour [line]
  (let [parts (str/split line " ")]
    (if (>= (len parts) 2)
      (let [time (nth parts 1)]
        (first (str/split time ":")))
      "00")))

(println (log-content
          |> (str/split "\n")
          |> (filter (fn [s] (> (len s) 0)))
          |> (map extract-hour)
          |> (group-by identity)
          |> (map (fn [[hour lines]] [f"{hour}æ™‚" (len lines)]))))

;; ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£è¿½è·¡
(println "\n=== ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ ===")

(println (log-content
          |> (str/split "\n")
          |> (filter (fn [line] (or (str/includes? line "login")
                                     (str/includes? line "logout"))))
          |> (map (fn [line]
                    (let [parts (str/split line " ")]
                      {:time (str (nth parts 0) " " (nth parts 1))
                       :action (nth parts 3)
                       :user (if (>= (len parts) 5) (nth parts 4) "unknown")})))
          |> (take 10)))

;; ã‚¨ãƒ©ãƒ¼ç‡ã®è¨ˆç®—
(println "\n=== ã‚¨ãƒ©ãƒ¼ç‡ ===")

(def total-logs
  (len (filter (fn [s] (> (len s) 0))
               (str/split log-content "\n"))))

(def error-logs
  (len (filter (fn [line] (str/includes? line "ERROR"))
               (str/split log-content "\n"))))

(println f"ç·ãƒ­ã‚°æ•°: {total-logs}")
(println f"ã‚¨ãƒ©ãƒ¼æ•°: {error-logs}")
(println f"ã‚¨ãƒ©ãƒ¼ç‡: {(/ (* error-logs 100) total-logs)}%")

;; ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã§ãƒ­ã‚°ãƒ‘ãƒ¼ã‚¹
(println "\n=== ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã§ãƒ­ã‚°è§£æ ===")

(defn parse-log-line [line]
  (match (str/split line " ")
    [date time level & rest] ->
      {:date date
       :time time
       :level level
       :message (str/join " " rest)}
    _ -> {:error "Invalid log format"}))

(println (log-content
          |> (str/split "\n")
          |> (filter (fn [s] (> (len s) 0)))
          |> (map parse-log-line)
          |> (take 3)))

;; Unixã‚³ãƒãƒ³ãƒ‰ã¨ã®çµ±åˆ
(println "\n=== Unixã‚³ãƒãƒ³ãƒ‰ã¨ã®çµ±åˆ ===")

; tailé¢¨ã®å‡¦ç†ï¼ˆæœ€å¾Œã®Nè¡Œï¼‰
(defn tail-n [filename n]
  (let [content (io/read-file filename)]
    (content
     |> (str/split "\n")
     |> (filter (fn [s] (> (len s) 0)))
     |> reverse
     |> (take n)
     |> reverse
     |> (str/join "\n"))))

(println "æœ€å¾Œã®3è¡Œ:")
(println (tail-n "/tmp/app.log" 3))

;; grepé¢¨ã®å‡¦ç†
(println "\n=== grepé¢¨ã®å‡¦ç† ===")

(defn grep-file [filename pattern]
  (let [content (io/read-file filename)]
    (content
     |> (str/split "\n")
     |> (filter (fn [line] (str/includes? line pattern)))
     |> (str/join "\n"))))

(println "ERRORã‚’å«ã‚€è¡Œ:")
(println (grep-file "/tmp/app.log" "ERROR"))

;; è¤‡é›‘ãªãƒ­ã‚°åˆ†æãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
(println "\n=== è¤‡é›‘ãªãƒ­ã‚°åˆ†æãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ ===")

(defn analyze-logs [filename]
  (let [content (io/read-file filename)]
    (content
     |> (str/split "\n")
     |> (filter (fn [s] (> (len s) 0)))
     |> (map parse-log-line)
     |> (filter (fn [log] (not (error? log))))
     |> (group-by (fn [log] (get log :level)))
     |> (map (fn [[level logs]]
               {:level level
                :count (len logs)
                :samples (take 2 logs)})))))

(println (analyze-logs "/tmp/app.log"))

;; ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é¢¨ã®ãƒ­ã‚°ç›£è¦–ï¼ˆæ¨¡æ“¬ï¼‰
(println "\n=== ãƒ­ã‚°ç›£è¦–ï¼ˆæ¨¡æ“¬ï¼‰ ===")

(defn monitor-errors [content]
  (content
   |> (str/split "\n")
   |> (filter (fn [line] (or (str/includes? line "ERROR")
                              (str/includes? line "WARN"))))
   |> (map (fn [line]
             (match (extract-log-level line)
               "ERROR" -> f"ğŸ”´ {line}"
               "WARN" -> f"ğŸŸ¡ {line}"
               _ -> line)))))

(println (monitor-errors log-content |> (str/join "\n")))

(println "\n=== ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ===")
(cmd/exec ["rm" "/tmp/app.log"])
(println "ã‚µãƒ³ãƒ—ãƒ«ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")

(println "\n=== Qiã§ãƒ­ã‚°è§£æãŒç°¡å˜ã«ï¼ ===")
(println "æ¬¡ã¯ 10-file-processing.qi ã§ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚’å­¦ã³ã¾ã—ã‚‡ã†")
