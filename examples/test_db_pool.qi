;; データベースコネクションプールのテスト

(println "=== データベースコネクションプールのテスト ===")

;; 0. テスト用DBファイルが存在する場合は削除
(if (io/file-exists? "/tmp/test_pool.db")
  (do
    (io/delete-file "/tmp/test_pool.db")
    (println "既存のDBファイルを削除しました")))

;; 1. コネクションプールを作成
(println "\n1. プールを作成（最大5接続）")
(def pool (db/create-pool "sqlite:/tmp/test_pool.db" {} 5))
(println "プール作成完了:" pool)

;; 2. プールの統計情報を確認
(println "\n2. プールの統計情報（初期状態）")
(def stats (db/pool-stats pool))
(println "統計情報:" stats)
(println "  - 利用可能:" (get stats "available"))
(println "  - 使用中:" (get stats "in_use"))
(println "  - 最大数:" (get stats "max"))

;; 3. プールから接続を取得
(println "\n3. プールから接続を取得")
(def conn1 (db/pool-acquire pool))
(println "接続1を取得:" conn1)

(def stats2 (db/pool-stats pool))
(println "統計情報（1接続取得後）:" stats2)
(println "  - 利用可能:" (get stats2 "available"))
(println "  - 使用中:" (get stats2 "in_use"))

;; 4. 接続を使用してテーブルを作成
(println "\n4. テーブルを作成")
(db/exec conn1 "CREATE TABLE users (id INTEGER PRIMARY KEY, name TEXT)" [])
(println "テーブル作成完了")

;; 5. データを挿入
(println "\n5. データを挿入")
(db/exec conn1 "INSERT INTO users (name) VALUES (?)" ["Alice"])
(db/exec conn1 "INSERT INTO users (name) VALUES (?)" ["Bob"])
(println "データ挿入完了")

;; 6. データを取得
(println "\n6. データを取得")
(def users (db/query conn1 "SELECT * FROM users" []))
(println "取得したデータ:" users)

;; 7. 2つ目の接続を取得
(println "\n7. 2つ目の接続を取得")
(def conn2 (db/pool-acquire pool))
(println "接続2を取得:" conn2)

(def stats3 (db/pool-stats pool))
(println "統計情報（2接続取得後）:" stats3)
(println "  - 利用可能:" (get stats3 "available"))
(println "  - 使用中:" (get stats3 "in_use"))

;; 8. 2つ目の接続でクエリを実行（同じテーブルにアクセス）
(println "\n8. 接続2でクエリを実行")
(def users2 (db/query conn2 "SELECT * FROM users WHERE name = ?" ["Alice"]))
(println "取得したデータ:" users2)

;; 9. 接続をプールに返却
(println "\n9. 接続1をプールに返却")
(db/pool-release pool conn1)
(println "接続1を返却完了")

(def stats4 (db/pool-stats pool))
(println "統計情報（1接続返却後）:" stats4)
(println "  - 利用可能:" (get stats4 "available"))
(println "  - 使用中:" (get stats4 "in_use"))

;; 10. 返却した接続を再利用
(println "\n10. プールから接続を再取得（再利用される）")
(def conn3 (db/pool-acquire pool))
(println "接続3を取得:" conn3)

(def stats5 (db/pool-stats pool))
(println "統計情報（再取得後）:" stats5)
(println "  - 利用可能:" (get stats5 "available"))
(println "  - 使用中:" (get stats5 "in_use"))

;; 11. プール全体をクローズ
(println "\n11. プール全体をクローズ")
(db/pool-release pool conn2)
(db/pool-release pool conn3)
(db/pool-close pool)
(println "プールをクローズ完了")

(println "\n=== テスト完了 ===")
