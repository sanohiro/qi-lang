;; 14-websocket.qi - WebSocket通信
;;
;; WebSocketクライアント機能の使用例
;; 実行: qi examples/14-websocket.qi

(println "=== WebSocket通信の例 ===\n")

;; 基本的な接続とメッセージ送受信
(println "=== 基本的な接続 ===")

;; 公開WebSocket Echoサーバーに接続
;; 注意: 実際に動作させるには、WebSocketサーバーが必要です
(println "WebSocket Echo サーバーへの接続例:")
(println "(def conn (ws/connect \"wss://echo.websocket.org\"))")
(println "(ws/send conn \"Hello, WebSocket!\")")
(println "(def response (ws/receive conn))")
(println "(println response)")
(println "(ws/close conn)")

;; メッセージの送受信パターン
(println "\n=== メッセージタイプ ===")
(println "受信できるメッセージタイプ:")
(println "1. テキストメッセージ:")
(println "   {:type \"message\" :data \"受信したテキスト\"}")
(println "")
(println "2. バイナリメッセージ:")
(println "   {:type \"binary\" :data \"base64エンコードされたデータ\"}")
(println "")
(println "3. クローズメッセージ:")
(println "   {:type \"close\" :code 1000 :reason \"Normal closure\"}")
(println "")
(println "4. エラー:")
(println "   {:type \"error\" :error \"エラーメッセージ\"}")

;; エラーハンドリング
(println "\n=== エラーハンドリング ===")
(println "接続エラーの処理:")
(println "")
(println "(defn safe-ws-connect [url]")
(println "  (try")
(println "    (ws/connect url)")
(println "    |>? (fn [conn]")
(println "          (if (error? conn)")
(println "            (do")
(println "              (println f\"接続失敗: {conn}\")")
(println "              nil)")
(println "            conn))))")

;; チャットボット風の例
(println "\n=== チャットボット風の実装 ===")
(println "")
(println "(defn ws-echo-client [url messages]")
(println "  (let [conn (ws/connect url)]")
(println "    (if (error? conn)")
(println "      (println f\"接続エラー: {conn}\")")
(println "      (do")
(println "        ;; メッセージを順次送信")
(println "        (each (fn [msg]")
(println "                (do")
(println "                  (println f\"送信: {msg}\")")
(println "                  (ws/send conn msg)")
(println "                  (let [response (ws/receive conn)]")
(println "                    (match (get response :type)")
(println "                      \"message\" -> (println f\"受信: {(get response :data)}\")")
(println "                      \"close\" -> (println \"サーバーが接続を閉じました\")")
(println "                      \"error\" -> (println f\"エラー: {(get response :error)}\")")
(println "                      _ -> (println f\"不明なメッセージ: {response}\")))))")
(println "              messages)")
(println "        ;; 接続をクローズ")
(println "        (ws/close conn)")
(println "        (println \"接続を閉じました\")))))")
(println "")
(println ";; 使用例:")
(println ";; (ws-echo-client \"wss://echo.websocket.org\"")
(println ";;                 [\"Hello\" \"WebSocket\" \"Goodbye\"])")

;; JSONメッセージの送受信
(println "\n=== JSONメッセージの送受信 ===")
(println "")
(println "(defn send-json-message [conn data]")
(println "  (let [json-str (json/stringify data)]")
(println "    (ws/send conn json-str)))")
(println "")
(println "(defn receive-json-message [conn]")
(println "  (let [response (ws/receive conn)]")
(println "    (match (get response :type)")
(println "      \"message\" -> (json/parse (get response :data))")
(println "      _ -> response)))")
(println "")
(println ";; 使用例:")
(println ";; (def conn (ws/connect \"ws://localhost:8080/api/ws\"))")
(println ";; (send-json-message conn {:action \"subscribe\" :channel \"chat\"})")
(println ";; (def msg (receive-json-message conn))")

;; 再接続ロジック
(println "\n=== 再接続ロジック ===")
(println "")
(println "(defn ws-connect-with-retry [url max-retries]")
(println "  (loop [retries 0]")
(println "    (let [conn (try (ws/connect url))]")
(println "      (if (error? conn)")
(println "        (if (< retries max-retries)")
(println "          (do")
(println "            (println f\"接続失敗。リトライ {(+ retries 1)}/{max-retries}\")")
(println "            (recur (+ retries 1)))")
(println "          (do")
(println "            (println \"最大リトライ回数に達しました\")")
(println "            nil))")
(println "        conn))))")

;; 実際の使用例（コメントアウト）
(println "\n=== 実際の使用例 ===")
(println "以下のコードで実際にWebSocketサーバーと通信できます:")
(println "")
(println ";; WebSocket Echo サーバーに接続")
(println ";; (def conn (ws/connect \"wss://echo.websocket.org\"))")
(println ";; ")
(println ";; ;; メッセージを送信")
(println ";; (ws/send conn \"Hello from Qi!\")")
(println ";; ")
(println ";; ;; レスポンスを受信")
(println ";; (def response (ws/receive conn))")
(println ";; (println f\"受信: {response}\")")
(println ";; ")
(println ";; ;; 接続を閉じる")
(println ";; (ws/close conn)")

(println "\n=== WebSocket通信が使えるようになりました！ ===")
(println "注意: 実際に動作させるには、WebSocketサーバーが必要です")
