;; test-sample.qi - レビュー用サンプルコード
;;
;; このファイルは意図的に改善の余地があるコードを含んでいます

;; 問題1: ネストした関数呼び出し（パイプライン化すべき）
(defn calculate-sum [numbers]
  (reduce + (map (fn [x] (* x x)) (filter (fn [n] (> n 0)) numbers))))

;; 問題2: エラーハンドリングなし
(defn fetch-user-data [url]
  (let [response (http/get url)]
    (let [body (get response :body)]
      (json/parse body))))

;; 問題3: 並列化できるが逐次処理
(defn process-images [images]
  (map (fn [img]
         (let [resized (resize-image img)]
           (compress-image resized)))
       images))

;; 問題4: 述語関数の命名規則違反（?がない）
(defn is-valid [data]
  (and (some? data) (> (len data) 0)))

;; 問題5: 複雑なif-elseチェーン（matchを使うべき）
(defn handle-response [response]
  (if (= (get response :status) 200)
    (process-success response)
    (if (= (get response :status) 404)
      nil
      (if (= (get response :status) 500)
        (log-error "Server error")
        (log-error "Unknown error")))))

;; 問題6: モジュールシステム未使用
;; (module宣言やexportがない)

;; 正しい例も含める（比較用）
(defn correct-pipeline-example [data]
  (data
   |> (filter positive?)
   |> (map (fn [x] (* x x)))
   |> sum))
