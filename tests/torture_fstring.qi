;; Torture Test: F-String (様々な極端なパターン)
;; パーサー・レキサーの限界を調べる拷問テスト

(println "=== Torture Test: F-String ===\n")

;; Test 1: 空のf-string
(println "Test 1: 空のf-string")
(def result1 f"")
(println (if (= result1 "") "✓ PASS" "✗ FAIL"))

;; Test 2: 変数なしのf-string（通常の文字列と同じ）
(println "\nTest 2: 変数なしのf-string")
(def result2 f"hello world")
(println (if (= result2 "hello world") "✓ PASS" "✗ FAIL"))

;; Test 3: 100個の変数展開
(println "\nTest 3: 100個の変数展開")
(def v 1)
(def result3 f"{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}{v}")
(println (if (= (len result3) 100) "✓ PASS" "✗ FAIL"))

;; Test 4: ネストされた{}（マップリテラル）
(println "\nTest 4: f-string内でのマップリテラル")
(def result4 f"{(get {:x 10 :y 20} :x)}")
(println (if (= result4 "10") "✓ PASS" "✗ FAIL"))

;; Test 5: 深くネストされたマップアクセス
(println "\nTest 5: 深くネストされたマップアクセス")
(def deep {:a {:b {:c {:d {:e 42}}}}})
(def result5 f"{(get (get (get (get (get deep :a) :b) :c) :d) :e)}")
(println (if (= result5 "42") "✓ PASS" "✗ FAIL"))

;; Test 6: f-string内でのmatch式（数値返却）
(println "\nTest 6: f-string内でのmatch式（数値返却）")
(def x 5)
(def result6 f"{(match x 5 -> 100 _ -> 0)}")
(println (if (= result6 "100") "✓ PASS" "✗ FAIL"))

;; Test 7: f-string内でのif式（数値返却）
(println "\nTest 7: f-string内でのif式（数値返却）")
(def result7 f"{(if (> 10 5) 1 0)}")
(println (if (= result7 "1") "✓ PASS" "✗ FAIL"))

;; Test 8: f-string内でのlet式
(println "\nTest 8: f-string内でのlet式")
(def result8 f"{(let [a 10 b 20] (+ a b))}")
(println (if (= result8 "30") "✓ PASS" "✗ FAIL"))

;; Test 9: f-string内でのdo式
(println "\nTest 9: f-string内でのdo式")
(def result9 f"{(do (def tmp 100) tmp)}")
(println (if (= result9 "100") "✓ PASS" "✗ FAIL"))

;; Test 10: f-string内でのloop-recur
(println "\nTest 10: f-string内でのloop-recur")
(def result10 f"{(loop [i 0 sum 0] (if (>= i 5) sum (recur (inc i) (+ sum i))))}")
(println (if (= result10 "10") "✓ PASS" "✗ FAIL"))

;; Test 11: f-string内でのベクター操作
(println "\nTest 11: f-string内でのベクター操作")
(def result11 f"{(first [1 2 3])} {(first (rest [1 2 3]))} {(len [1 2 3])}")
(println (if (= result11 "1 2 3") "✓ PASS" "✗ FAIL"))

;; Test 12: f-string内でのmap関数
(println "\nTest 12: f-string内でのmap関数")
(def result12 f"{(reduce + 0 (map (fn [x] (* x 2)) [1 2 3]))}")
(println (if (= result12 "12") "✓ PASS" "✗ FAIL"))

;; Test 13: f-string内でのfilter関数
(println "\nTest 13: f-string内でのfilter関数")
(def result13 f"{(len (filter (fn [x] (> x 5)) [1 3 5 7 9]))}")
(println (if (= result13 "2") "✓ PASS" "✗ FAIL"))

;; Test 14: f-string内での文字列連結（変数使用）
(println "\nTest 14: f-string内での文字列連結（変数使用）")
(def s1 "hello")
(def s2 "world")
(def sp " ")
(def result14 f"{(str s1 sp s2)}")
(println (if (= result14 "hello world") "✓ PASS" "✗ FAIL"))

;; Test 15: 複数行f-stringでの複雑な式
(println "\nTest 15: 複数行f-stringでの複雑な式")
(def x 10)
(def y 20)
(def result15 f"""Line 1: {(+ x y)}
Line 2: {(* x y)}
Line 3: {(/ y x)}""")
(println (if (str/contains? result15 "Line 1: 30") "✓ PASS" "✗ FAIL"))

;; Test 16: f-string内での無名関数呼び出し
(println "\nTest 16: f-string内での無名関数呼び出し")
(def result16 f"{((fn [a b] (+ a b)) 10 20)}")
(println (if (= result16 "30") "✓ PASS" "✗ FAIL"))

;; Test 17: f-string内でのパイプライン
(println "\nTest 17: f-string内でのパイプライン")
(def result17 f"{(10 |> inc |> inc |> (* 2 _))}")
(println (if (= result17 "24") "✓ PASS" "✗ FAIL"))

;; Test 18: 連続したf-string
(println "\nTest 18: 連続したf-string")
(def a 1)
(def b 2)
(def result18 (str f"{a}" f"{b}" f"{(+ a b)}"))
(println (if (= result18 "123") "✓ PASS" "✗ FAIL"))

;; Test 19: f-string内での算術式の連続
(println "\nTest 19: f-string内での算術式の連続")
(def result19 f"{(+ 1 2)} {(- 10 5)} {(* 3 4)} {(/ 20 4)}")
(println (if (= result19 "3 5 12 5") "✓ PASS" "✗ FAIL"))

;; Test 20: 超長いf-string（1000文字以上）
(println "\nTest 20: 超長いf-string（1000文字以上）")
(def data (str/repeat "x" 100))
(def result20 f"{data}{data}{data}{data}{data}{data}{data}{data}{data}{data}")
(println (if (= (len result20) 1000) "✓ PASS" "✗ FAIL"))

;; Test 21: f-string内での深い再帰関数呼び出し
(println "\nTest 21: f-string内での深い再帰関数呼び出し")
(defn factorial [n]
  (if (<= n 1) 1 (* n (factorial (- n 1)))))
(def result21 f"factorial(10) = {(factorial 10)}")
(println (if (= result21 "factorial(10) = 3628800") "✓ PASS" "✗ FAIL"))

;; Test 22: f-string内での特殊文字
(println "\nTest 22: f-string内での特殊文字")
(def tab "\t")
(def newline "\n")
(def result22 f"tab:{tab}end")
(println (if (str/contains? result22 "tab:") "✓ PASS" "✗ FAIL"))

;; Test 23: f-string内でのnil値
(println "\nTest 23: f-string内でのnil値")
(def nil-val nil)
(def result23 f"{nil-val}")
(println (if (= result23 "nil") "✓ PASS" "✗ FAIL"))

;; Test 24: f-string内でのboolean値
(println "\nTest 24: f-string内でのboolean値")
(def result24 f"{true} {false}")
(println (if (= result24 "true false") "✓ PASS" "✗ FAIL"))

;; Test 25: f-string内でのキーワード
(println "\nTest 25: f-string内でのキーワード")
(def result25 f"{:hello} {:world}")
(println (if (= result25 ":hello :world") "✓ PASS" "✗ FAIL"))

;; Test 26: f-string内での浮動小数点数
(println "\nTest 26: f-string内での浮動小数点数")
(def result26 f"{3.14} {(/ 22 7)}")
(println (if (str/starts-with? result26 "3.14") "✓ PASS" "✗ FAIL"))

;; Test 27: f-string内での負の数
(println "\nTest 27: f-string内での負の数")
(def result27 f"{-10} {(- 0 5)}")
(println (if (= result27 "-10 -5") "✓ PASS" "✗ FAIL"))

;; Test 28: ネストされた関数定義とf-string
(println "\nTest 28: ネストされた関数定義とf-string")
(def result28 (let [double (fn [x] (* x 2))
                     triple (fn [x] (* x 3))]
                f"{(double 5)} {(triple 5)}"))
(println (if (= result28 "10 15") "✓ PASS" "✗ FAIL"))

;; Test 29: f-string内でのリスト内包表記的な処理
(println "\nTest 29: f-string内でのmap+reduce")
(def empty-str "")
(def result29 f"{(reduce str empty-str (map str [1 2 3 4 5]))}")
(println (if (= result29 "12345") "✓ PASS" "✗ FAIL"))

;; Test 30: 空の式を含むf-string
(println "\nTest 30: 複雑な空白を含むf-string")
(def result30 f"  {1}  {2}  {3}  ")
(println (if (str/contains? result30 "1") "✓ PASS" "✗ FAIL"))

(println "\n=== Torture Test 完了 ===")
