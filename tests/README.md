# Qiパターンテストスイート

このディレクトリには、Qiの重要な機能に対する包括的なパターンテストが含まれています。

## 概要

これらのテストは**リリース前のパターンテスト**として設計されており、以下を目的としています：

- **matchパターンマッチング**と**macマクロシステム**の様々な使用パターンを網羅
- 実際の使用シナリオに基づいたストレステスト
- エッジケースと境界条件の検証
- リグレッション防止（過去のエラーが多かった機能）

## テストファイル

### 1. control_flow_comprehensive.qi

**目的**: 制御フロー・パイプラインの包括的テスト

**テスト数**: 58個

**カバレッジ**:
- ✅ if条件分岐
  - 真偽値リテラル、nil/false判定
  - 空のデータ構造（リスト、マップ、文字列）
  - and/or/not条件
  - 5層の深いネスト

- ✅ do複数式実行
  - 空、単一、複数式
  - 副作用の順序確認
  - 3層のネスト

- ✅ loop/recur末尾再帰
  - 基本パターン（カウントダウン、累積和）
  - フィボナッチ数列、リスト処理
  - 10000回の大量反復
  - 複数の累積変数

- ✅ パイプライン |>
  - 単一・複数関数チェーン
  - 数値・文字列・リスト処理
  - map/filter/reduce組み合わせ
  - 10段の長いパイプライン
  - 関数の部分適用

- ✅ Railway Pipeline |>?
  - 成功チェーン、エラーでショートサーキット
  - バリデーション（positive、even）
  - 実用的なエラーハンドリング

- ✅ 並列パイプライン ||>
  - リストへの関数適用
  - チェーン処理
  - 複雑な関数

- ✅ tryエラー処理
  - 成功・エラーケース
  - matchとの組み合わせ

- ✅ 複合パターン
  - if + loop、do + loop + if
  - パイプライン + match
  - loop + パイプライン

- ✅ ストレステスト
  - 10000回反復ループ
  - 10段パイプライン
  - フィボナッチ20
  - 100要素リスト処理

- ✅ エッジケース
  - nil/false/0の真偽判定
  - 空リスト処理
  - パイプラインで空データ

**実行方法**:
```bash
./target/release/qi tests/control_flow_comprehensive.qi
```

**期待される結果**: 58個のテストすべてが成功（成功率100%）

---

### 2. match_comprehensive.qi

**目的**: matchパターンマッチングの包括的テスト

**テスト数**: 82個

**カバレッジ**:
- ✅ 基本パターン
  - 値のマッチ（整数、文字列、nil/bool）
  - マップのマッチ（単純、ネスト、部分マッチ）
  - リスト/ベクタのマッチ（空、単一、複数、残り要素）
  - ガード条件（単純、複雑、範囲チェック）

- ✅ 拡張パターン
  - `:as` 束縛（全体と部分の両方を使用）
  - `=> 変換`（Qi独自の機能、変換関数の適用）

- ✅ エッジケース
  - ワイルドカード `_`
  - 複雑なネスト構造（5層、10層）
  - 型の混在（文字列と数値、nil含む）
  - 空のデータ構造

- ✅ 実用的なパターン
  - APIレスポンス処理
  - HTTPステータスコード処理
  - データ変換パイプライン
  - 数値範囲チェック
  - 型判定（8種類の型）

- ✅ ストレステスト
  - 深いネスト（10層のマップ）
  - 長いリスト（10要素の全マッチ）
  - 複雑な条件（複数ガードの組み合わせ）
  - 大量パターン（HTTPステータス13種類）

**実行方法**:
```bash
./target/release/qi tests/match_comprehensive.qi
```

**期待される結果**: 82個のテストすべてが成功（成功率100%）

---

### 3. macro_basic.qi

**目的**: マクロシステムの基本機能テスト

**テスト数**: 12個

**カバレッジ**:
- ✅ 基本マクロ
  - `when` - 条件が真の時のみ実行
  - `unless` - whenの逆

- ✅ quasiquote機能
  - `\`` (backtick) - quasiquote
  - `,` - unquote（値の埋め込み）
  - `,@` - unquote-splice（リストの展開）

- ✅ マクロ展開
  - `eval`とquasiquoteの組み合わせ
  - ネストしたマクロ
  - 再帰的マクロ（simple-cond）

- ✅ 実用的なパターン
  - マクロと関数の組み合わせ
  - 複数のbody式
  - quasiquoteのネスト

**実行方法**:
```bash
./target/release/qi tests/macro_basic.qi
```

**期待される結果**: 12個のテストすべてが成功（成功率100%）

---

## テスト結果サマリー

| テストスイート | テスト数 | 成功 | 失敗 | 成功率 |
|---------------|---------|------|------|--------|
| control_flow_comprehensive | 58 | 58 | 0 | 100% |
| match_comprehensive | 82 | 82 | 0 | 100% |
| macro_basic | 12 | 12 | 0 | 100% |
| **合計** | **152** | **152** | **0** | **100%** |

## 実装の注意点

### match

以下のパターンは完全に実装済み：
- 基本パターン（値、nil/bool、マップ、リスト、ガード）
- 拡張パターン（`:as`束縛、`=> 変換`）
- ワイルドカード `_`
- 深いネスト構造

### マクロ

以下の機能は実装済み：
- `mac` - マクロ定義
- quasiquote (`` ` ``), unquote (`,`), unquote-splice (`,@`)
- `eval` - 式の評価
- 再帰的マクロ

**制限事項**:
- マクロ内で`def`の第一引数にunquoteを使用することはサポートされていません
  ```lisp
  ;; これは動作しません
  (mac defn [name params & body]
    `(def ,name (fn ,params ,@body)))
  ```

この制限により、一部の高度なマクロパターンは実装できませんが、基本的なマクロ機能はすべて動作します。

## 継続的な改善

これらのテストは、Qiの開発過程で最も問題が発生しやすかった機能をカバーしています：

1. **matchパターンマッチング**
   - 複雑なネスト構造でのパース問題
   - ガード条件の評価順序
   - 型の混在したデータ構造

2. **マクロシステム**
   - quasiquoteとunquoteの正しい展開
   - マクロのネストと再帰
   - 変数のスコープとキャプチャ

将来的に新しいパターンや問題が発見された場合は、これらのテストスイートに追加してください。

## 実行スクリプト

すべてのテストを一度に実行する場合：

```bash
# 制御フロー・パイプラインテスト
echo "=== Control Flow & Pipeline Comprehensive Test ==="
./target/release/qi tests/control_flow_comprehensive.qi

echo ""
# matchテスト
echo "=== Match Comprehensive Test ==="
./target/release/qi tests/match_comprehensive.qi

echo ""
# マクロテスト
echo "=== Macro Basic Test ==="
./target/release/qi tests/macro_basic.qi
```

## 貢献

新しいテストパターンを追加する場合：

1. 実際の使用ケースに基づいたテストを作成
2. エッジケースと境界条件を含める
3. 期待される結果を明確に記述
4. このREADMEを更新して新しいテストを文書化

## ライセンス

Qiプロジェクトと同じライセンスに従います。
