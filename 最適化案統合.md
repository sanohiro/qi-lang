# 統合バックログ（重複統合済み・情報欠落なし）

## A. 環境/Env・クロージャ捕捉

**A1 [P0] Env をロックレスな永続環境に再設計**

- **Action**: `Arc<RwLock<Env>>` 親参照をやめ、`Arc<EnvNode>`（親ポインタ＋im::HashMap 差し替え）に。`set`系でロック不要化。
- **Files**: `src/value.rs (Env/EnvNode)`, `src/eval.rs`（束縛/レキシカル参照）, `src/builtins/*` の `set!/swap` 系
- **Why/統合**: Env が `Arc<RwLock<..>>` のため更新ごとにロック（複数指摘）。永続マップとの一貫性/性能向上（複数ブロックで一致）。クロージャ作成時の環境コピーも削減（「Function が Env を値コピー」指摘と統合）。

**A2 [P1] Function に名前・逆引きテーブルを保持（プロファイル高速化）**

- **Action**: 関数定義時に `Function { name: Arc<str> }` を埋める。加えて `HashMap<Arc<Function>, Arc<str>>` の逆引きを（デバッグ/プロファイル時のみ）保持。
- **Files**: `src/eval.rs:get_function_name`, `src/value.rs:Function`
- **Why**: グローバル線形走査の O(n) がプロファイル時ボトルネック（複数指摘一致）。

**A3 [P1] 高階関数の一時環境汚染を排除**

- **Action**: `native_partial`/`native_comp` の `__partial_args__` 等の環境書き込みを廃止。`FunctionBody` に variant を追加。
- **Files**: `src/builtins/hof.rs`, `src/value.rs`
- **Why**: 汚染リスク＋ルックアップ増大（複数指摘）。

------

## B. 永続コレクション（Vector/List/Map/Set）

**B1 [P0] List 系を cons 最適化（O(1)）**

- **Action**: `Value::List` を `im::conslist::ConsList<Value>`（or `im::list::List`）へ。`cons/rest`/`push_front` ホットパスを O(1)。
- **Files**: `src/builtins/core_collections.rs`, `src/value.rs`
- **Why**: 現状 Vector ベースで cons/rest が O(n)（複数指摘）。

**B2 [P0] im::Vector API によるスライス/append 直利用**

- **Action**: `iter().take()→Vec→.into()` をやめ、`slice/split_at/append/from_iter/with_capacity` を直接使用。
- **Files**: `src/builtins/list.rs`（例: :63 :92 :149 ほか）, `hof.rs`, `core_collections.rs`
- **Why**: 中間 Vec/再配置削減（多数箇所で一致）。

**B3 [P1] Vec を使う必要がある箇所の事前確保/SmallVec**

- **Action**: 一時 Vec は `with_capacity(見積)`、引数配列は `SmallVec<[Value;4/8]>`。
- **Files**: `src/eval.rs:apply_function`, `builtins/*`
- **Why**: 小規模配列のヒープ確保回避（複数指摘）。

**B4 [P1] Set 演算の安定ハッシュ化**

- **Action**: `HashSet<String>+format!("{:?}")` を廃止。`Value` の安定ハッシュ（`hash_stable()` or ラッパ）で `im::HashSet` へ格納。
- **Files**: `src/builtins/set.rs`, `src/value.rs`
- **Why**: 文字列化によるヒープ/CPU 無駄が大（明確指摘）。

**B5 [P2] Vector/List の比較ショートカット**

- **Action**: 比較時に `ptr::eq` 先行→長大構造の O(1) 早期 true。
- **Files**: 比較ヘルパ/`values_equal`
- **Why**: 共有ノード活用（複数指摘）。

------

## C. 文字列・シンボル・正規表現

**C1 [P0] シンボル/キーワードのインターン導入**

- **Action**: `SymbolTable`（`once_cell::sync::Lazy`＋`DashMap`）で `SymbolId(u32)`、比較/ハッシュを整数化。
- **Files**: `src/value.rs`, `src/lexer.rs`（read_symbol/keyword）, `src/parser.rs`（parse_symbol）, `core_predicates`
- **Why**: 重複生成・比較コスト削減（多数一致）。

**C2 [P0] Value::String を Arc に**

- **Action**: 共有文字列へ統一。外部境界のみ `to_string`。
- **Files**: `src/value.rs`, 文字列生成箇所全般
- **Why**: 重複文字列大量生成の抑制（多数一致）。

**C3 [P0] Regex のコンパイル/キャッシュ/型追加**

- **Action**: `once_cell::Lazy + DashMap<String, Regex>` でパターンキャッシュ。さらに `Value::Regex(Arc<Regex>)` を導入し再利用。
- **Files**: `src/builtins/string.rs`（re_* 群）, `src/value.rs`
- **Why**: `Regex::new` の都度コンパイル回避（多数一致）。

**C4 [P1] 文字列 API の中間 Vec/Vec<&str> 排除**

- **Action**: `char_indices()` と `&s[start..end]` 借用で切り出し／`with_capacity`＋`write!/push_*` で連結。
- **Files**: `src/builtins/string.rs`（:20,:44,:150,:171,:186,:222,:278,:332, ケース変換群, re_* 戻り値連結）
- **Why**: 中間確保の全廃（詳細指摘多数）。

------

## D. Lexer / Parser

**D1 [P0] Lexer 入力を Vec から &str 走査へ**

- **Action**: `&str` オフセット（or `&[u8]`＋`memchr`）で高速化。
- **Files**: `src/lexer.rs`（:38 ほか）
- **Why**: UTF-8 を char 単位 copy は高コスト（明確指摘）。

**D2 [P1] トークン逐次イテレータ化**

- **Action**: `Vec<Token>` 一括返却→`impl Iterator<Item=Result<Token>>`（REPL メモリピーク抑制）。
- **Files**: `src/lexer.rs`
- **Why**: 大入力/REPL でのピーク抑制（提案一致）。

**D3 [P1] Parser のシンボル/キーワードもインターン**

- **Action**: `parse_symbol` で clone 多用を撤廃、ID 比較へ。`SPECIAL_FORMS` は `match` テーブル or `phf::Set`。
- **Files**: `src/parser.rs`（:14, :185, :212 ほか）
- **Why**: 比較・判定の分岐/アロケーション削減（複数指摘）。

**D4 [P2] AST のベクタを im::Vector へ（巨大ASTの複製対策）**

- **Action**: `Expr::Vector/Map/FnParam` などで im を採用（マクロ展開などで恩恵）。
- **Files**: `src/parser.rs`, `src/ast.rs`
- **Why**: 巨大 AST コピー削減（指摘あり）。

------

## E. Evaluator / 呼び出し系 / 数値・比較

**E1 [P0] `apply_function` の引数コピー削減**

- **Action**: `args.to_vec()` 廃止。`Cow<[Value]>` 受け/`SmallVec` 併用。
- **Files**: `src/eval.rs:993,1084` 付近
- **Why**: 呼び出しホットパスの確保削減（複数一致）。

**E2 [P1] 末尾再帰 `recur` のトランポリン化**

- **Action**: ループ変換（Clojure/Gleam 風）。
- **Files**: `src/eval.rs:1542`
- **Why**: 深い再帰のスタック枯渇防止（指摘）。

**E3 [P1] 数値演算・比較の try_fold/2項最適化/checked_* **

- **Action**: `native_add/sub/mul` は `try_fold`＋早期エラー/オーバーフロー検出。2項はトップレベル `match` で分岐削減。
- **Files**: `src/builtins/core_numeric.rs`
- **Why**: ホットパス最適化（複数一致）。

**E4 [P2] 型昇格（i64↔f64）パス追加**

- **Action**: Web 実用性向上のため整数専用から自動昇格。
- **Files**: 同上
- **Why**: 実用性＋分岐縮小（提案）。

**E5 [P1] `values_equal` の共有ノードショートカット**

- **Action**: `im::Vector/HashMap` 比較の `ptr::eq` 先行。
- **Files**: `core_numeric.rs`（:204 付近）
- **Why**: 長大コレクション比較高速化（複数一致）。

------

## F. ビルトイン（List/HOF/String/Map/Predicates/State/IO/HTTP/Server/DB/JSON/CSV/YAML/Markdown/Regex）

**F1 [P0] List/HOF の中間 Vec 全排除**

- **Action**: `im::Vector::with_capacity/from_iter/push_front/append/slice/split_off` へ全面移行。
- **Files**: `src/builtins/list.rs`（:63,:92,:149 ほか）, `src/builtins/hof.rs`
- **Why**: 途中でエフェメラルな Vec に落とすのを禁止（多数一致）。

**F2 [P0] String 系：split/pad/squish/ケース変換の中間確保削減**

- **Action**: `char_indices` 採用、`with_capacity` 連結、`split_words` を借用ベース化、re_* はキャッシュ。
- **Files**: `src/builtins/string.rs`（:20,:44,:150,:171,:186,:222,:278,:332, :463〜, :1283〜）
- **Why**: 詳細指摘多数（全反映）。

**F3 [P0] Regex API のキャッシュ＋型導入（C3併記）**

- **Action**: 上記 C3 に合わせ、`Markdown` 同等の事前コンパイル思想を string 側にも。
- **Files**: `src/builtins/string.rs`, `src/builtins/markdown.rs`
- **Why**: 再コンパイル抑制（複数一致）。

**F4 [P1] Map 操作のエントリ/構造共有最適化**

- **Action**: `assoc_in/dissoc_in` で不必要な clone をやめ、im の構造共有活用。`update_keys` は一時 `Vec`→`from_iter` でまとめる。
- **Files**: `src/builtins/map.rs`
- **Why**: 深い階層でのコピー削減（一致）。

**F5 [P1] Predicates/Display/str まわりの借用化**

- **Action**: `Value::as_*` アクセサ導入。`Display/native_str` は `fmt::Write` に直接出力＋容量見積もり。
- **Files**: `src/value.rs`, `src/builtins/core_string.rs`
- **Why**: 冗長な to_string/format 蓄積削減（複数）。

**F6 [P0] IO/HTTP：ボディの Bytes 対応・ストリーミング化**

- **Action**: `Value::Bytes(Arc<Vec<u8>>)` 追加。クライアント `response.text()` 強制をやめ、JSON 以外はバイトのまま。Server 側も `Value::Stream`/Bytes をサポート（集約 read の撤廃）。
- **Files**: `src/builtins/http.rs`, `src/builtins/server.rs`, `src/value.rs`
- **Why**: 文字列前提でバイナリ破壊/大メモリ消費（多数一致）。

**F7 [P1] HTTP クライアントの Client 共有/タイムアウト別キャッシュ**

- **Action**: 既存 `LazyLock<Client>` を拡張し、`timeout_ms` ごと LRU キャッシュ（`DashMap<u64, Client>`）。ヘッダ名は `Arc<str>` or `HeaderMap` 直使用。
- **Files**: `src/builtins/http.rs`
- **Why**: 毎回 builder/TLS 初期化回避、文字列化削減（一致）。

**F8 [P1] Server/Tokio ランタイム共有**

- **Action**: `native_server_serve` が毎回 `Runtime::new()` するのをやめ、共有ランタイム取得 API。
- **Files**: `src/builtins/server.rs`, `lazy_init::http_server`
- **Why**: 多サーバー時のコスト削減（一致）。

**F9 [P1] IO ファイル/ストリームの真のストリーミング化**

- **Action**: `read_to_string` 全読込を排除、`BufReader` 逐次／行/バイトストリームのバッファ再利用。`CHUNK_SIZE` 可変。`Value::Path` or `OsString` 対応。
- **Files**: `src/builtins/io.rs`
- **Why**: ピークメモリ抑制・非 UTF-8 パス対応（詳細指摘）。

**F10 [P1] DB/SQLite：ID/ロック/ステートメントキャッシュ**

- **Action**: グローバル管理を `DashMap`＋整数 ID。`rusqlite::Connection::prepare_cached`。ロック粒度を縮小。
- **Files**: `src/builtins/db.rs`, `sqlite.rs`
- **Why**: 直列化/lookup ボトルネック解消（詳細指摘）。

**F11 [P1] JSON/CSV/YAML：容量見積もり＋標準高速実装・借用化**

- **Action**: `with_capacity`（配列/オブジェクト長見積）、文字列は `Arc<str>`/インターン。CSV は `csv` crate へ（SIMD/真ストリーミング）。YAML は位置情報抽出・im 直詰め。
- **Files**: `src/builtins/json.rs`, `csv.rs`, `yaml.rs`
- **Why**: 中間二重化/全読み/文字列複製を解消（多数一致）。

**F12 [P2] Markdown：借用ベース＋`RegexSet`/join 排除**

- **Action**: 解析は `&str`/`Cow<'a,str>`を優先、行配列の一括生成を避ける。`String::with_capacity`＋`write!` 連結。`RegexSet` で複数判定を一括。
- **Files**: `src/builtins/markdown.rs`
- **Why**: 中間 String/Vec 多発の抑制（詳細一致）。

------

## G. i18n / メッセージ

**G1 [P0] HashMap 依存の排除（配列直索引）**

- **Action**: `#[repr(usize)]` 化した `MsgKey` により `static EN_MSGS:[&'static str;N]`/`JA_MSGS` を直引き。
- **Files**: `src/i18n.rs`
- **Why**: ルックアップ O(1)、局所性向上（詳細提案）。

**G2 [P1] テンプレートの事前分割＋`write!` 結合**

- **Action**: `String::replace` 多用を廃止し、プレースホルダ分割済み配列から一度の `with_capacity` 連結。
- **Files**: 同上
- **Why**: 割り込みアロケーションの全削減（詳細提案）。

**G3 [P2] 生成コード自動化 & 言語切替 API**

- **Action**: `build.rs` で yaml/json → const 配列生成。`set_lang()` で配列ポインタ差替。
- **Files**: `build.rs`, `src/i18n.rs`
- **Why**: 初期化/切替コスト最小化（詳細一致）。

------

## H. エラー/結果表現・型

**H1 [P1] `Result<Value, Error>` へ内部統一**

- **Action**: 全ビルトインの `{:ok}/{:error}` Map を内部では `Result` に。API出口でのみ Map へ。
- **Files**: `builtins/*`, 共通エラー型
- **Why**: 余計な HashMap 確保/文字列生成削減（複数一致）。

**H2 [P1] エラー文字列の `Arc<str>/Cow<'static,str>` 化**

- **Action**: 生成コスト/多言語連結の削減。
- **Files**: 全エラー生成箇所
- **Why**: 頻出メッセージのアロケーション削減（複数一致）。

------

## I. プロファイル/ベンチ/品質ゲート

**I1 [P0] ベンチ/計測の標準化**

- **Action**: `cargo bench` + `criterion`、`perf`/`dhat` セット。`hot path`（cons/rest/concat、正規表現、JSON/CSV/YAML 大規模、apply_function）をベンチ対象化。
- **Why**: 「途中で Vec/HashMap を行き来」検知と回帰防止（指摘）。

**I2 [P1] 受け入れ基準（例）**

- cons/rest：O(n)→O(1) を確認（要マイクロベンチ）
- 正規表現：同パターン連続 1000 回で >5× 改善
- JSON 100MB：ピーク RSS ▲30% 以上
- HTTP バイナリ：`Value::Bytes` 経由でゼロコピー応答（再エンコード無し）
- `apply_function`：引数 ≤4 のケースでヒープ確保 0 回

------

# 実装順（短期→中期→長期）

**短期（今週）**

- A1, B1, C1, C2, D1, E1, F1, F2, F3, G1, I1（基盤/ホットパス）
   **中期（来週〜）**
- A2, A3, B2, B3, B4, E3, F6, F7, F8, F9, F10, F11, G2, H1, H2
   **長期**
- D2, D3, D4, E2, E4, F12, G3, B5, I2

------

# 変更に伴うインターフェース追加/型追加（新規）

- `Value::Bytes(Arc<Vec<u8>>)`／`Value::Regex(Arc<Regex>)`／`Value::Path`
- `SymbolId(u32)` と `SymbolTable`（intern/extract API）
- `EnvNode`（親差替え可能な永続環境ノード）
- `Value::as_*` 借用アクセサ群
- 共通 `Error` 型（`Result<Value, Error>`）

------

# リファクタリング規約（回帰防止）

- 「中間 Vec/HashMap を作ってから `.into()`」禁止。永続構造 API を直接使う。
- 文字列処理は**基本借用**、連結は**with_capacity+write!**、パースは**逐次**。
- 正規表現は**必ず**キャッシュ or 事前コンパイル／`Value::Regex` を許容。
- 大きな I/O/HTTP は**バイトストリーム/Bytes**優先、文字列化は必要時のみ。
- Env/クロージャは**ロックレス永続**、`RwLock` は極力排除。

------

