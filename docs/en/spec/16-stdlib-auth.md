# Authentication and Authorization

**Authentication with JWT (JSON Web Token) and Password Hashing**

Qi provides authentication features required for modern web applications as part of its standard library.

---

## Table of Contents

- [Overview](#overview)
- [JWT (JSON Web Token)](#jwt-json-web-token)
  - [jwt/sign - Token Generation](#jwtsign---token-generation)
  - [jwt/verify - Token Verification](#jwtverify---token-verification)
  - [jwt/decode - Token Decoding](#jwtdecode---token-decoding)
- [Password Hashing](#password-hashing)
  - [password/hash - Password Hashing](#passwordhash---password-hashing)
  - [password/verify - Password Verification](#passwordverify---password-verification)
- [Practical Examples](#practical-examples)

---

## Overview

### Provided Features

- **JWT Authentication**: Stateless token-based authentication
  - Token generation (jwt/sign)
  - Token verification (jwt/verify)
  - Token decoding (jwt/decode)
  - HS256/HS384/HS512 algorithm support

- **Password Hashing**: Secure password management with Argon2
  - Hashing (password/hash)
  - Verification (password/verify)
  - Automatic salt generation

### Feature Flags

```toml
# Cargo.toml
features = ["auth-jwt", "auth-password"]
```

Enabled by default.

---

## JWT (JSON Web Token)

### jwt/sign - Token Generation

**Generates a JWT token from payload and secret key.**

```qi
(jwt/sign payload secret)
(jwt/sign payload secret algorithm)
(jwt/sign payload secret algorithm exp)
```

#### Arguments

- `payload`: Map (data to include in token)
- `secret`: String (secret key for signing)
- `algorithm`: String (optional, default: "HS256")
  - Supports "HS256", "HS384", "HS512"
- `exp`: Integer (optional, expiration time in seconds)

#### Return Value

- Success: Token string
- Failure: `{:error "error message"}`

#### Usage Examples

```qi
;; Basic usage (default is HS256)
(def result (jwt/sign {:user_id 123 :name "Alice"} "my-secret"))
;; => "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."

;; Specify algorithm
(jwt/sign {:role "admin"} "secret" "HS384")

;; Specify expiration (3600 seconds = 1 hour)
(jwt/sign {:user_id 42} "secret" "HS256" 3600)

;; Pipeline usage
({:user_id 999 :role "user"}
 |> (jwt/sign "my-secret")
 |>? (fn [token] (println "Token:" token)))
```

---

### jwt/verify - Token Verification

**Verifies JWT token and extracts payload.**

```qi
(jwt/verify token secret)
(jwt/verify token secret algorithm)
```

#### Arguments

- `token`: String (JWT token to verify)
- `secret`: String (secret key for verification)
- `algorithm`: String (optional, default: "HS256")

#### Return Value

- Success: Payload map
- Failure: `{:error "error message"}`

#### Usage Examples

```qi
;; Verify token and get payload
(def result (jwt/verify token "my-secret"))
;; => {:user_id 123 :name "Alice"}

;; Verification failure example
(jwt/verify "invalid-token" "secret")
;; => {:error "Invalid token"}

;; Pipeline usage
(token
 |>? (jwt/verify "my-secret")
 |>? (fn [payload] (get payload :user_id)))
;; => 123
```

---

### jwt/decode - Token Decoding

**Decodes JWT token without verification (no signature verification).**

This is a debugging function for inspecting token contents.

```qi
(jwt/decode token)
```

#### Arguments

- `token`: String (JWT token to decode)

#### Return Value

- Success: `{:header header-map :payload payload-map}`
- Failure: `{:error "error message"}`

#### Usage Examples

```qi
;; Decode token (no signature verification)
(def result (jwt/decode token))
;; => {:header {:typ "JWT" :alg "HS256"}
;;     :payload {:user_id 123 :name "Alice"}}

;; Get header only
(jwt/decode token
 |>? (fn [data] (get data :header)))
;; => {:typ "JWT" :alg "HS256"}
```

⚠️ **Warning**: This function does not verify signatures. Use only for debugging or testing purposes.

---

## Password Hashing

### password/hash - Password Hashing

**Hashes password with Argon2.**

Argon2 is a faster and more secure password hashing algorithm than bcrypt.

```qi
(password/hash password)
```

#### Arguments

- `password`: String (password to hash)

#### Return Value

- Success: Hash string (Value::String)
- Failure: Error (exception)

#### Usage Examples

```qi
;; Hash password
(def hash (password/hash "my-password"))
;; => "$argon2id$v=19$m=19456,t=2,p=1$..."

;; Same password produces different hashes (automatic salt generation)
(def hash1 (password/hash "test"))
(def hash2 (password/hash "test"))
(println (= hash1 hash2))  ;; => false
```

---

### password/verify - Password Verification

**Verifies password against hash.**

```qi
(password/verify password hash)
```

#### Arguments

- `password`: String (password to verify)
- `hash`: String (hash generated by password/hash)

#### Return Value

- `true`: Password matches
- `false`: Password does not match

#### Usage Examples

```qi
;; Verify password
(def hash (password/hash "my-password"))

(password/verify "my-password" hash)  ;; => true
(password/verify "wrong-password" hash)  ;; => false

;; Invalid hash format returns false
(password/verify "test" "invalid-hash")  ;; => false
```

---

## Practical Examples

### User Login Feature

```qi
;; User registration
(defn register-user [username password]
  (let [hash (password/hash password)]
    {:username username
     :password_hash hash}))

;; User login
(defn login [username password stored-hash]
  (if (password/verify password stored-hash)
    (jwt/sign {:username username} "app-secret" "HS256" 3600)
    {:error "Invalid credentials"}))

;; Usage example
(def user (register-user "alice" "secret123"))
;; => {:username "alice" :password_hash "$argon2id$..."}

(def token-result (login "alice" "secret123" (get user :password_hash)))
;; => "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
```

### API Authentication Middleware

```qi
;; Extract authentication info from token
(defn authenticate [token]
  (token
   |>? (jwt/verify "app-secret")
   |>? (fn [payload] (get payload :username))))

;; Protected endpoint
(defn protected-endpoint [request]
  (let [auth-header (get-in request [:headers :authorization])
        token (string/replace-first auth-header "Bearer " "")
        auth-result (authenticate token)]
    (match auth-result
      {:error _} -> {:status 401 :body "Unauthorized"}
      username -> {:status 200 :body (str "Hello, " username)})))
```

### Password Change Flow

```qi
;; Change password
(defn change-password [old-password new-password stored-hash]
  (if (password/verify old-password stored-hash)
    (password/hash new-password)
    {:error "Current password is incorrect"}))

;; Usage example
(def current-hash "$argon2id$v=19$m=19456,t=2,p=1$...")
(def new-hash (change-password "old-pass" "new-pass" current-hash))
;; => "$argon2id$v=19$m=19456,t=2,p=1$..." (new hash)
```

---

## Security Best Practices

### JWT

1. **Secret Key Management**
   - Manage secret keys with environment variables
   - Use sufficiently long and random strings

2. **Expiration Time**
   - Always set expiration time for tokens
   - Short expiration (within 1 hour) recommended

3. **HTTPS Required**
   - Always transmit tokens over HTTPS
   - HTTP has eavesdropping risks

### Password Hashing

1. **Automatic Salt Generation**
   - `password/hash` automatically generates salts
   - Same password produces different hashes

2. **Advantages of Argon2**
   - Faster and more secure than bcrypt
   - Memory-hard function (resistant to GPU attacks)
   - Winner of 2015 Password Hashing Competition

3. **Hash Storage**
   - Hashes can be stored directly in database
   - Includes algorithm, parameters, salt, and hash

---

## Related Documentation

- **[11-stdlib-http.md](11-stdlib-http.md)** - Integration with HTTP server
- **[12-stdlib-json.md](12-stdlib-json.md)** - Handling JSON data
- **[08-error-handling.md](08-error-handling.md)** - Result type patterns
- **[17-stdlib-database.md](17-stdlib-database.md)** - Database integration

---

## Implementation Details

### Crates Used

- **jsonwebtoken** (v9.2) - JWT generation/verification
- **argon2** (v0.5) - Password hashing

### Feature Flags

```toml
# Enabled by default
default = ["auth-jwt", "auth-password", ...]

# Can be disabled individually
minimal = []  # No authentication features
```

---

## Summary

Qi's authentication library provides simple and secure authentication features.

- **JWT**: Stateless token authentication
- **Argon2**: Modern and secure password hashing
- **Result Type**: Unified error handling

By combining these features, you can easily build authentication systems for modern web applications.
