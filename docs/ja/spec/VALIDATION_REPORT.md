# Qiドキュメント検証レポート

検証日: 2025-11-15
対象: docs/ja/spec/ 配下のMarkdownファイル

---

## 検証結果サマリー

### 優先5ファイルの検証結果

| ファイル | コード例数 | 成功 | エラー | 成功率 |
|---------|-----------|------|--------|--------|
| 02-flow-pipes.md | 17 | 5 | 12 | 29.4% |
| 03-concurrency.md | 22 | 18 | 4 | 81.8% |
| 04-match.md | 14 | 1 | 13 | 7.1% |
| 05-syntax-basics.md | 41 | 25 | 16 | 61.0% |
| 10-stdlib-string.md | 20 | 16 | 4 | 80.0% |
| **合計** | **114** | **65** | **49** | **57.0%** |

---

## 修正したバグ

### 1. ✅ `go/select!` 構文の誤り

**問題**: ドキュメントに記載されていた構文が実装と異なっていた

**ドキュメントの誤った記載**:
```qi
(go/select!
  ch1 (fn [val] ...)
  ch2 (fn [val] ...))
```

**正しい構文**:
```qi
(go/select! [
  [ch1 (fn [val] ...)]
  [ch2 (fn [val] ...)]])
```

**修正箇所**: `03-concurrency.md:83`

---

### 2. ✅ キーワード関数アクセスの誤り

**問題**: Clojure風のキーワード関数アクセス `(:key map)` が未実装

**ドキュメントの誤った記載**:
```qi
(get user :name)  ;; => "Bob"
```

**正しい構文**:
```qi
(get user :name)  ;; => "Bob"
```

**修正箇所**:
- `05-syntax-basics.md:125`
- `05-syntax-basics.md:87` (f-string内のマップアクセス)

---

### 3. ✅ Set構文 `#{}` の削除

**問題**: Set型のリテラル構文が未実装

**ドキュメントの誤った記載**:
```qi
(def clients (atom #{}))
```

**修正後**:
```qi
(def clients (atom []))  ;; ベクターを使用
```

**修正箇所**: `03-concurrency.md:311`

---

### 4. ✅ スレッディングマクロ `->` の削除

**問題**: Clojure風のスレッディングマクロが未実装

**ドキュメントの誤った記載**:
```qi
(-> (go/run (fn [] 10))
    (go/then (fn [x] (* x 2)))
    (go/await))
```

**修正後**:
```qi
(def p (go/run (fn [] 10)))
(def p2 (go/then p (fn [x] (* x 2))))
(go/await p2)
```

**修正箇所**: `03-concurrency.md:188`

---

## 残存する問題

### エラー分類

| カテゴリ | 件数 | 説明 |
|---------|------|------|
| 未定義変数 | 35 | 概念的な例で未定義の変数を使用 |
| 外部API | 1 | 実際に存在しないAPIへのアクセス |
| その他 | 13 | その他の構文エラーや未実装機能 |

---

### 典型的な未定義変数の例

**ファイル**: `02-flow-pipes.md:28`

```qi
;; 基本
(data |> parse |> transform |> save)
```

**エラー**: `未定義の変数: data, parse, transform, save`

**問題**: 概念的な説明のための擬似コード

**推奨対応**:
1. 実行可能な完全な例に書き換える
2. `(comment ...)` で囲んで実行不可であることを明示

---

### 外部APIアクセスの例

**ファイル**: `02-flow-pipes.md:153`

```qi
("https://api.example.com/users/123" |> http/get ...)
```

**エラー**: `error sending request for url`

**推奨対応**: モックデータを使った例に変更

---

## 修正内容の検証

修正後の成功率: **57.0%** (65/114)
修正前の成功率: **52.6%** (60/114)
改善: **+4.4%** (5件のバグ修正)

---

## 推奨される追加作業

### 優先度: 高

1. **未定義変数の例を実行可能にする**
   - 02-flow-pipes.md: 12件
   - 04-match.md: 13件
   - 05-syntax-basics.md: 10件以上

2. **概念的な例とコード例の分離**
   - 概念説明 → コメント or 別セクション
   - コード例 → 必ず実行可能な完全な例

### 優先度: 中

3. **残り33ファイルの検証**
   - 06-data-structures.md
   - 07-functions.md
   - 08-error-handling.md
   - 09-modules.md
   - 11-stdlib-http.md
   - ...等

4. **エラーハンドリングの例の改善**
   - tryブロックの使用例を増やす
   - エラーケースの処理を明確にする

### 優先度: 低

5. **表記の統一**
   - コメント形式の統一
   - インデントの統一
   - 出力例の記載方法の統一

---

## 検証方法

### 使用したツール

- Python検証スクリプト: `/tmp/verify_docs.py`
- Qiインタープリタ: `/Users/hiro/Projects/qi-lang/target/release/qi`

### 検証手順

1. Markdownファイルから `` ```qi `` ブロックを抽出
2. コメントやREPLプロンプトを除去
3. 一時ファイルに保存して実行
4. エラーを分類・分析

### スキップした例

- `(comment ...)` ブロック
- HTTPサーバー起動コード (`http/listen`)
- 外部リソース依存 (`db/`, `kvs/`, `sql`)

---

## 今後の改善提案

1. **CI/CDでのドキュメント検証**
   - GitHub Actionsでコード例を自動テスト
   - PRマージ前に検証を必須化

2. **ドキュメント作成ガイドライン**
   - コード例は必ず実行可能にする
   - 概念的な例は `(comment ...)` で囲む
   - 外部リソースが必要な例はモックを使用

3. **標準的なテストデータの整備**
   - サンプルデータファイル
   - モックAPI
   - テスト用の共通関数

---

## まとめ

- ✅ 優先5ファイルの検証完了
- ✅ 主要なバグ4件を修正
- ✅ 成功率を52.6% → 57.0%に改善
- 🔄 残存する49件のエラーは主に未定義変数（概念的な例）
- 📝 実行可能な完全な例への書き換えを推奨
