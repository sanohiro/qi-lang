; test_stdlib_io_and_path.qi
; このファイルはQi言語のI/OおよびPath標準ライブラリのテストです。
; 意図: ファイルおよびディレクトリの操作が仕様通りに動作することを確認します。

(use test :only [run assert-eq assert])
(use io)
(use path)

(run "Path Manipulation Functions" (fn []
  ; 意図: パス文字列の結合や分解が正しく行えるか。
  (assert-eq "a/b/c" (join "a" "b" "c"))
  (assert-eq "/a/b" (join "/a" "b"))
  (assert-eq "file.txt" (basename "/path/to/file.txt"))
  (assert-eq "/path/to" (dirname "/path/to/file.txt"))
  (assert-eq "txt" (extension "/path/to/file.txt"))
  (assert-eq "" (extension "/path/to/file"))
))

(run "File and Directory Operations" (fn []
  ; 意図: ファイルとディレクトリの作成、読み書き、移動、削除が正しく行えるか。
  (def base-dir (temp-dir-keep))
  (defer (delete-dir base-dir :recursive true))

  ; 1. ディレクトリ操作
  (def sub-dir (path/join base-dir "sub"))
  (create-dir sub-dir)
  (assert (is-dir? sub-dir))

  ; 2. ファイル書き込みと存在確認
  (def file-path (path/join sub-dir "test.txt"))
  (write-file "hello" file-path)
  (assert (file-exists? file-path))
  (assert (is-file? file-path))

  ; 3. ファイル読み込み
  (assert-eq "hello" (read-file file-path))

  ; 4. ファイル追記
  (append-file " world" file-path)
  (assert-eq "hello world" (read-file file-path))

  ; 5. ファイルコピー
  (def copy-path (path/join base-dir "test_copy.txt"))
  (copy-file file-path copy-path)
  (assert (file-exists? copy-path))
  (assert-eq "hello world" (read-file copy-path))

  ; 6. ファイル移動 (リネーム)
  (def move-path (path/join base-dir "test_moved.txt"))
  (move-file copy-path move-path)
  (assert (not (file-exists? copy-path)))
  (assert (file-exists? move-path))

  ; 7. ディレクトリ一覧
  (write-file "" (path/join sub-dir "another.txt"))
  (def dir-content (list-dir sub-dir |> sort))
  (assert-eq ["another.txt" "test.txt"] (map basename dir-content |> sort))

  ; 8. ファイル削除
  (delete-file move-path)
  (assert (not (file-exists? move-path)))

  ; 9. ディレクトリ削除
  (delete-dir sub-dir :recursive true)
  (assert (not (is-dir? sub-dir)))
))

(run "IO Write Options" (fn []
  ; 意図: :if-exists や :create-dirs などの書き込みオプションが機能するか。
  (def base-dir (temp-dir-keep))
  (defer (delete-dir base-dir :recursive true))

  ; :create-dirs
  (def deep-path (path/join base-dir "a" "b" "c.txt"))
  (write-file "deep" deep-path :create-dirs true)
  (assert-eq "deep" (read-file deep-path))

  ; :if-exists :error
  (assert-throws (fn [] (write-file "fail" deep-path :if-exists :error)))

  ; :if-exists :skip
  (write-file "skip" deep-path :if-exists :skip)
  (assert-eq "deep" (read-file deep-path)) ; 内容が変わっていないことを確認

  ; :if-exists :append
  (write-file "-append" deep-path :if-exists :append)
  (assert-eq "deep-append" (read-file deep-path))

  ; :if-exists :overwrite (default)
  (write-file "overwrite" deep-path)
  (assert-eq "overwrite" (read-file deep-path))
))