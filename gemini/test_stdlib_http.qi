; test_stdlib_http.qi
; このファイルはQi言語のHTTP標準ライブラリ (http/, server/) のテストです。
; 意図: HTTPクライアントとサーバーの機能が仕様通りに動作することを確認します。

(use http)
(use server)
(use json)

; -----------------------------------------------------------------------------
; -- HTTP Client (http/) Tests
; -- Note: These tests require an internet connection and access to httpbin.org
; -----------------------------------------------------------------------------

(test/run "HTTP Client - GET request" (fn []
  ; 意図: http/getが正常に動作し、200 OKレスポンスを返すか。
  (match (http/get "https://httpbin.org/get")
    {:ok resp} -> (test/assert-eq 200 (get resp "status"))
    {:error e} -> (test/assert false (str "HTTP GET failed: " e))))

(test/run "HTTP Client - GET with query params" (fn []
  ; 意図: クエリパラメータ付きのGETリクエストを正しく処理できるか。
  (match (http/get "https://httpbin.org/get?foo=bar&num=123")
    {:ok resp} -> {
      (match (json/parse (get resp "body"))
        {:ok body} -> {
          (test/assert-eq "bar" (get-in body ["args" "foo"]))
          (test/assert-eq "123" (get-in body ["args" "num"]))
        }
        _ -> (test/assert false "Failed to parse response body")
      )
    }
    {:error e} -> (test/assert false (str "HTTP GET with params failed: " e))))

(test/run "HTTP Client - POST with JSON body" (fn []
  ; 意図: JSONボディを持つPOSTリクエストを正しく送信できるか。
  (def payload {:name "Qi" :type "language"})
  (match (http/post "https://httpbin.org/post" payload)
    {:ok resp} -> {
      (test/assert-eq 200 (get resp "status"))
      (match (json/parse (get resp "body"))
        {:ok body} -> (test/assert-eq payload (get body "json"))
        _ -> (test/assert false "Failed to parse POST response body")
      )
    }
    {:error e} -> (test/assert false (str "HTTP POST failed: " e))))

(test/run "HTTP Client - Railway Pipeline Integration" (fn []
  ; 意図: |>? パイプラインを使って、HTTPレスポンスの取得とパースを安全に連鎖できるか。
  (def result ("https://httpbin.org/json"
               |> http/get
               |>? (fn [resp] (json/parse (get resp "body")))
               |>? (fn [body] {:ok (get-in body ["slideshow" "title"]}})
              ))
  (test/assert-eq {:ok "Sample Slide Show"} result)

  (def error_result ("https://invalid-url-for-qi-test.com"
                     |> http/get
                     |>? (fn [resp] (json/parse (get resp "body")))
                    ))
  (test/assert (get error_result :error))
))

; -----------------------------------------------------------------------------
; -- HTTP Server (server/) Tests (Offline Logic)
; -----------------------------------------------------------------------------

(test/run "HTTP Server - Basic Routing" (fn []
  ; 意図: server/routerがリクエストを正しいハンドラにディスパッチできるか。
  (def hello-handler (fn [req] (server/ok "Hello")))
  (def json-handler (fn [req] (server/json {:status "ok"})))

  (def app (server/router [["/" {"get" hello-handler}]
                           ["/api" {"get" json-handler}]]))

  ; Test hello-handler
  (def req1 {:method "get" :path "/"})
  (def resp1 (app req1))
  (test/assert-eq 200 (get resp1 "status"))
  (test/assert-eq "Hello" (get resp1 "body"))

  ; Test json-handler
  (def req2 {:method "get" :path "/api"})
  (def resp2 (app req2))
  (test/assert-eq 200 (get resp2 "status"))
  (test/assert-eq "application/json" (get-in resp2 ["headers" "Content-Type"]))
  (test/assert-eq "{\"status\":\"ok\"}" (get resp2 "body"))

  ; Test not found
  (def req3 {:method "get" :path "/not-found"})
  (def resp3 (app req3))
  (test/assert-eq 404 (get resp3 "status"))
))

(test/run "HTTP Server - Path Parameters" (fn []
  ; 意図: /users/:id のようなパスパラメータを抽出し、ハンドラに渡せるか。
  (def user-handler (fn [req]
    (let [user-id (get-in req ["params" "id"])]
      (server/json {:user_id user-id})))

  (def app (server/router [["/users/:id" {"get" user-handler}]]))

  (def req {:method "get" :path "/users/123"})
  (def resp (app req))

  (test/assert-eq 200 (get resp "status"))
  (match (json/parse (get resp "body"))
    {:ok body} -> (test/assert-eq "123" (get body "user_id"))
    _ -> (test/assert false "Could not parse param response"))
))

(test/run "HTTP Server - Middleware" (fn []
  ; 意図: ミドルウェアがハンドラを正しくラップし、機能するか。
  (def handler (fn [req] (server/ok "data")))

  ; with-corsミドルウェアをテスト
  (def cors-app (server/with-cors handler))
  (def resp (cors-app {}))
  (test/assert-eq "*" (get-in resp ["headers" "Access-Control-Allow-Origin"]))

  ; with-json-bodyミドルウェアをテスト
  (def json-body-handler (fn [req]
    (let [name (get-in req ["json" "name"])]
      (server/ok (str "Hello, " name)))))

  (def json-app (server/with-json-body json-body-handler))
  (def req {:body "{\"name\":\"Qi\"}"})
  (def resp (json-app req))
  (test/assert-eq "Hello, Qi" (get resp "body"))
))
