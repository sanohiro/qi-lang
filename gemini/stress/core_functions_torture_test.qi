; core_functions_torture_test.qi
; Core高階関数（3個）の torture test
;
; 関数基礎(3): identity, constantly, partial

(println "========================================")
(println "Core高階関数 Torture Test 開始")
(println "========================================")

; ========================================
; Section 1: identity
; ========================================

(println "\n--- Section 1: identity ---")

; 1.1 基本的な動作
(println "\n[1.1] identity - 基本動作")
(def identity-basic-pass
  (and
    (= (identity 42) 42)
    (= (identity "hello") "hello")
    (= (identity true) true)
    (= (identity nil) nil)
    (= (identity [1 2 3]) [1 2 3])
    (= (identity {:a 1}) {:a 1})))

(if identity-basic-pass
  (println "✓ identityの基本動作は正しく動作した")
  (println "✗ identityの基本動作に問題がある"))

; 1.2 複雑なデータ構造
(println "\n[1.2] identity - 複雑なデータ構造")
(def complex-data {:users [{:name "Alice" :age 30} {:name "Bob" :age 25}]
                   :total 2})
(def identity-complex-pass
  (= (identity complex-data) complex-data))

(if identity-complex-pass
  (println "✓ identityの複雑なデータ構造は正しく動作した")
  (println "✗ identityの複雑なデータ構造に問題がある"))

; 1.3 高階関数として使用
(println "\n[1.3] identity - 高階関数として")
(def identity-hof-pass
  (and
    (= (map identity [1 2 3]) [1 2 3])
    (= (filter identity [true false nil 1 0]) [true 1 0])
    (= (reduce (fn [acc x] (+ acc (identity x))) 0 [1 2 3]) 6)))

(if identity-hof-pass
  (println "✓ identityの高階関数としての使用は正しく動作した")
  (println "✗ identityの高階関数としての使用に問題がある"))

; 1.4 パイプラインで使用
(println "\n[1.4] identity - パイプライン")
(def identity-pipeline-pass
  (= (42 |> identity |> identity |> identity) 42))

(if identity-pipeline-pass
  (println "✓ identityのパイプライン使用は正しく動作した")
  (println "✗ identityのパイプライン使用に問題がある"))

; 1.5 大量データ
(println "\n[1.5] identity - 大量データ")
(def large-list (range 0 10000))
(def identity-bulk-pass
  (= (map identity large-list) large-list))

(if identity-bulk-pass
  (println "✓ identityの大量データ処理は正しく動作した")
  (println "✗ identityの大量データ処理に問題がある"))

; ========================================
; Section 2: constantly
; ========================================

(println "\n--- Section 2: constantly ---")

; 2.1 基本的な動作
(println "\n[2.1] constantly - 基本動作")
(def const-42 (constantly 42))
(def constantly-basic-pass
  (and
    (= (const-42 1) 42)
    (= (const-42 "ignored") 42)
    (= (const-42 nil) 42)
    (= ((constantly "hello") 999) "hello")
    (= ((constantly nil) "anything") nil)))

(if constantly-basic-pass
  (println "✓ constantlyの基本動作は正しく動作した")
  (println "✗ constantlyの基本動作に問題がある"))

; 2.2 複雑な値の保持
(println "\n[2.2] constantly - 複雑な値")
(def const-map (constantly {:status "ok" :data [1 2 3]}))
(def constantly-complex-pass
  (and
    (= (const-map 1) {:status "ok" :data [1 2 3]})
    (= (const-map "test") {:status "ok" :data [1 2 3]})))

(if constantly-complex-pass
  (println "✓ constantlyの複雑な値保持は正しく動作した")
  (println "✗ constantlyの複雑な値保持に問題がある"))

; 2.3 mapで使用
(println "\n[2.3] constantly - mapで使用")
(def constantly-map-pass
  (and
    (= (map (constantly 0) [1 2 3 4 5]) [0 0 0 0 0])
    (= (map (constantly "x") '(a b c)) ["x" "x" "x"])))

(if constantly-map-pass
  (println "✓ constantlyのmap使用は正しく動作した")
  (println "✗ constantlyのmap使用に問題がある"))

; 2.4 filterのデフォルト値として
(println "\n[2.4] constantly - filterで使用")
(def constantly-filter-pass
  (let [always-true (constantly true)
        always-false (constantly false)]
    (and
      (= (filter always-true [1 2 3]) [1 2 3])
      (= (filter always-false [1 2 3]) []))))

(if constantly-filter-pass
  (println "✓ constantlyのfilter使用は正しく動作した")
  (println "✗ constantlyのfilter使用に問題がある"))

; 2.5 大量データ
(println "\n[2.5] constantly - 大量データ")
(def constantly-bulk-pass
  (let [result (map (constantly 1) (range 0 10000))]
    (and
      (= (len result) 10000)
      (list/every? (fn [x] (= x 1)) result))))

(if constantly-bulk-pass
  (println "✓ constantlyの大量データ処理は正しく動作した")
  (println "✗ constantlyの大量データ処理に問題がある"))

; ========================================
; Section 3: partial
; ========================================

(println "\n--- Section 3: partial ---")

; 3.1 基本的な動作
(println "\n[3.1] partial - 基本動作")
(def add5 (partial + 5))
(def partial-basic-pass
  (and
    (= (add5 10) 15)
    (= (add5 0) 5)
    (= (add5 -5) 0)))

(if partial-basic-pass
  (println "✓ partialの基本動作は正しく動作した")
  (println "✗ partialの基本動作に問題がある"))

; 3.2 複数引数の部分適用
(println "\n[3.2] partial - 複数引数")
(def multiply (fn [a b c] (* a b c)))
(def mul-by-2-3 (partial multiply 2 3))
(def partial-multi-pass
  (and
    (= (mul-by-2-3 4) 24)
    (= (mul-by-2-3 5) 30)))

(if partial-multi-pass
  (println "✓ partialの複数引数部分適用は正しく動作した")
  (println "✗ partialの複数引数部分適用に問題がある"))

; 3.3 リスト関数での使用
(println "\n[3.3] partial - リスト関数")
(def take-2 (partial take 2))
(def partial-list-pass
  (and
    (= (take-2 [1 2 3 4 5]) [1 2])
    (= (take-2 [10 20 30]) [10 20])
    (= (take-2 [99]) [99])))

(if partial-list-pass
  (println "✓ partialのリスト関数使用は正しく動作した")
  (println "✗ partialのリスト関数使用に問題がある"))

; 3.4 mapでの使用
(println "\n[3.4] partial - mapで使用")
(def add-10 (partial + 10))
(def partial-map-pass
  (= (map add-10 [1 2 3 4 5]) [11 12 13 14 15]))

(if partial-map-pass
  (println "✓ partialのmap使用は正しく動作した")
  (println "✗ partialのmap使用に問題がある"))

; 3.5 部分適用の連続使用
(println "\n[3.5] partial - 連続使用")
(def add (fn [a b] (+ a b)))
(def add5 (partial add 5))
(def partial-chain-pass
  (and
    (= (add5 10) 15)
    (= (add5 0) 5)
    (= (add5 -5) 0)))

(if partial-chain-pass
  (println "✓ partialの連続使用は正しく動作した")
  (println "✗ partialの連続使用に問題がある"))

; 3.6 大量データでの使用
(println "\n[3.6] partial - 大量データ")
(def mul-by-2 (partial * 2))
(def partial-bulk-pass
  (let [result (map mul-by-2 (range 0 10000))]
    (and
      (= (len result) 10000)
      (= (first result) 0)
      (= (last result) 19998))))

(if partial-bulk-pass
  (println "✓ partialの大量データ処理は正しく動作した")
  (println "✗ partialの大量データ処理に問題がある"))

; ========================================
; Section 4: 統合テスト
; ========================================

(println "\n--- Section 4: 統合テスト ---")

; 4.1 3つの関数の組み合わせ
(println "\n[4.1] 3関数の組み合わせ")
(def integration-pass
  (let [const-10 (constantly 10)
        add-5 (partial + 5)
        data [1 2 3]]
    (and
      (= (map identity data) data)
      (= (map const-10 data) [10 10 10])
      (= (map add-5 data) [6 7 8]))))

(if integration-pass
  (println "✓ 3関数の組み合わせは正しく動作した")
  (println "✗ 3関数の組み合わせに問題がある"))

; 4.2 パイプラインでの統合
(println "\n[4.2] パイプラインでの統合")
(def pipeline-integration-pass
  (let [add-1 (partial + 1)]
    (= ([1 2 3] |> (map add-1) |> (map identity)) [2 3 4])))

(if pipeline-integration-pass
  (println "✓ パイプライン統合は正しく動作した")
  (println "✗ パイプライン統合に問題がある"))

; 4.3 高階関数での統合
(println "\n[4.3] 高階関数での統合")
(def hof-integration-pass
  (let [numbers [1 2 3 4 5]
        double (partial * 2)
        keep-even (fn [x] (even? x))
        result (filter keep-even (map double numbers))]
    (= result [2 4 6 8 10])))

(if hof-integration-pass
  (println "✓ 高階関数統合は正しく動作した")
  (println "✗ 高階関数統合に問題がある"))

; ========================================
; Section 5: 高負荷テスト
; ========================================

(println "\n--- Section 5: 高負荷テスト ---")

; 5.1 大量データでの3関数統合
(println "\n[5.1] 大量データでの3関数統合")
(def bulk-integration-pass
  (let [data (range 0 10000)
        const-1 (constantly 1)
        add-10 (partial + 10)
        identity-data (map identity data)
        const-data (map const-1 data)
        partial-data (map add-10 data)]
    (and
      (= (len identity-data) 10000)
      (= (len const-data) 10000)
      (= (len partial-data) 10000)
      (= (first partial-data) 10)
      (= (last partial-data) 10009))))

(if bulk-integration-pass
  (println "✓ 大量データでの3関数統合は正しく動作した")
  (println "✗ 大量データでの3関数統合に問題がある"))

; 5.2 並列処理
(println "\n[5.2] 並列処理")
(def parallel-pass
  (let [double (partial * 2)
        result (pmap double (range 0 1000))]
    (and
      (= (len result) 1000)
      (= (first result) 0)
      (= (last result) 1998))))

(if parallel-pass
  (println "✓ 並列処理は正しく動作した")
  (println "✗ 並列処理に問題がある"))

; ========================================
; 最終結果
; ========================================

(println "\n========================================")
(println "Core高階関数 Torture Test 完了")
(println "========================================")
(println "\n全セクションが実行されました。")
(println "各セクションのチェックマーク (✓/✗) を確認してください。")
