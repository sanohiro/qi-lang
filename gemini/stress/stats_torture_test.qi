; stats_torture_test.qi
; 統計関数（6個）の torture test
;
; stats/mean, stats/median, stats/mode, stats/variance, stats/stddev, stats/percentile

(println "========================================")
(println "統計関数 Torture Test 開始")
(println "========================================")

; ========================================
; Section 1: stats/mean
; ========================================

(println "\n--- Section 1: stats/mean ---")

; 1.1 基本動作
(println "\n[1.1] mean - 基本動作")
(def mean-basic-pass
  (and
    (= (stats/mean [1 2 3 4 5]) 3.0)
    (= (stats/mean [10 20 30]) 20.0)))

(if mean-basic-pass
  (println "✓ meanの基本動作は正しく動作した")
  (println "✗ meanの基本動作に問題がある"))

; 1.2 浮動小数点混在
(println "\n[1.2] mean - 浮動小数点混在")
(def mean-float-pass
  (let [result (stats/mean [1 2.5 3])]
    (float? result)))

(if mean-float-pass
  (println "✓ meanの浮動小数点混在は正しく動作した")
  (println "✗ meanの浮動小数点混在に問題がある"))

; 1.3 単一要素
(println "\n[1.3] mean - 単一要素")
(def mean-single-pass
  (= (stats/mean [42]) 42.0))

(if mean-single-pass
  (println "✓ meanの単一要素は正しく動作した")
  (println "✗ meanの単一要素に問題がある"))

; 1.4 大量データ
(println "\n[1.4] mean - 大量データ")
(def mean-bulk-pass
  (let [data (range 1 1001)
        result (stats/mean data)]
    (and
      (float? result)
      (= result 500.5))))

(if mean-bulk-pass
  (println "✓ meanの大量データ処理は正しく動作した")
  (println "✗ meanの大量データ処理に問題がある"))

; 1.5 負の数
(println "\n[1.5] mean - 負の数")
(def mean-negative-pass
  (= (stats/mean [-5 -3 -1 0 1 3 5]) 0.0))

(if mean-negative-pass
  (println "✓ meanの負の数は正しく動作した")
  (println "✗ meanの負の数に問題がある"))

; ========================================
; Section 2: stats/median
; ========================================

(println "\n--- Section 2: stats/median ---")

; 2.1 奇数個
(println "\n[2.1] median - 奇数個")
(def median-odd-pass
  (and
    (= (stats/median [1 2 3 4 5]) 3.0)
    (= (stats/median [10 20 30]) 20.0)))

(if median-odd-pass
  (println "✓ medianの奇数個は正しく動作した")
  (println "✗ medianの奇数個に問題がある"))

; 2.2 偶数個
(println "\n[2.2] median - 偶数個")
(def median-even-pass
  (and
    (= (stats/median [1 2 3 4]) 2.5)
    (= (stats/median [10 20 30 40]) 25.0)))

(if median-even-pass
  (println "✓ medianの偶数個は正しく動作した")
  (println "✗ medianの偶数個に問題がある"))

; 2.3 単一要素
(println "\n[2.3] median - 単一要素")
(def median-single-pass
  (= (stats/median [42]) 42.0))

(if median-single-pass
  (println "✓ medianの単一要素は正しく動作した")
  (println "✗ medianの単一要素に問題がある"))

; 2.4 ソート順序
(println "\n[2.4] median - ソート順序")
(def median-unsorted-pass
  (and
    (= (stats/median [5 1 3 2 4]) 3.0)
    (= (stats/median [40 10 30 20]) 25.0)))

(if median-unsorted-pass
  (println "✓ medianのソート順序は正しく動作した")
  (println "✗ medianのソート順序に問題がある"))

; 2.5 大量データ
(println "\n[2.5] median - 大量データ")
(def median-bulk-pass
  (let [data (range 1 1001)
        result (stats/median data)]
    (= result 500.5)))

(if median-bulk-pass
  (println "✓ medianの大量データ処理は正しく動作した")
  (println "✗ medianの大量データ処理に問題がある"))

; ========================================
; Section 3: stats/mode
; ========================================

(println "\n--- Section 3: stats/mode ---")

; 3.1 基本動作
(println "\n[3.1] mode - 基本動作")
(def mode-basic-pass
  (and
    (= (stats/mode [1 2 2 3 3 3]) 3)
    (= (stats/mode [5 5 5 10 10 15]) 5)))

(if mode-basic-pass
  (println "✓ modeの基本動作は正しく動作した")
  (println "✗ modeの基本動作に問題がある"))

; 3.2 すべて同じ値
(println "\n[3.2] mode - すべて同じ値")
(def mode-same-pass
  (= (stats/mode [7 7 7 7]) 7))

(if mode-same-pass
  (println "✓ modeのすべて同じ値は正しく動作した")
  (println "✗ modeのすべて同じ値に問題がある"))

; 3.3 単一要素
(println "\n[3.3] mode - 単一要素")
(def mode-single-pass
  (= (stats/mode [42]) 42))

(if mode-single-pass
  (println "✓ modeの単一要素は正しく動作した")
  (println "✗ modeの単一要素に問題がある"))

; 3.4 大量データ
(println "\n[3.4] mode - 大量データ")
(def mode-bulk-pass
  (let [data (concat (repeat 500 1) (repeat 300 2) (repeat 200 3))
        result (stats/mode data)]
    (= result 1)))

(if mode-bulk-pass
  (println "✓ modeの大量データ処理は正しく動作した")
  (println "✗ modeの大量データ処理に問題がある"))

; ========================================
; Section 4: stats/variance
; ========================================

(println "\n--- Section 4: stats/variance ---")

; 4.1 基本動作
(println "\n[4.1] variance - 基本動作")
(def variance-basic-pass
  (= (stats/variance [1 2 3 4 5]) 2.0))

(if variance-basic-pass
  (println "✓ varianceの基本動作は正しく動作した")
  (println "✗ varianceの基本動作に問題がある"))

; 4.2 すべて同じ値
(println "\n[4.2] variance - すべて同じ値")
(def variance-same-pass
  (= (stats/variance [5 5 5 5]) 0.0))

(if variance-same-pass
  (println "✓ varianceのすべて同じ値は正しく動作した")
  (println "✗ varianceのすべて同じ値に問題がある"))

; 4.3 単一要素
(println "\n[4.3] variance - 単一要素")
(def variance-single-pass
  (= (stats/variance [42]) 0.0))

(if variance-single-pass
  (println "✓ varianceの単一要素は正しく動作した")
  (println "✗ varianceの単一要素に問題がある"))

; 4.4 大量データ
(println "\n[4.4] variance - 大量データ")
(def variance-bulk-pass
  (let [data (range 0 100)
        result (stats/variance data)]
    (float? result)))

(if variance-bulk-pass
  (println "✓ varianceの大量データ処理は正しく動作した")
  (println "✗ varianceの大量データ処理に問題がある"))

; ========================================
; Section 5: stats/stddev
; ========================================

(println "\n--- Section 5: stats/stddev ---")

; 5.1 基本動作
(println "\n[5.1] stddev - 基本動作")
(def stddev-basic-pass
  (let [result (stats/stddev [1 2 3 4 5])
        expected (math/sqrt 2.0)]
    (= result expected)))

(if stddev-basic-pass
  (println "✓ stddevの基本動作は正しく動作した")
  (println "✗ stddevの基本動作に問題がある"))

; 5.2 すべて同じ値
(println "\n[5.2] stddev - すべて同じ値")
(def stddev-same-pass
  (= (stats/stddev [5 5 5 5]) 0.0))

(if stddev-same-pass
  (println "✓ stddevのすべて同じ値は正しく動作した")
  (println "✗ stddevのすべて同じ値に問題がある"))

; 5.3 varianceとの関係
(println "\n[5.3] stddev - varianceとの関係")
(def stddev-variance-pass
  (let [data [1 2 3 4 5]
        var (stats/variance data)
        std (stats/stddev data)]
    (= std (math/sqrt var))))

(if stddev-variance-pass
  (println "✓ stddevとvarianceの関係は正しく動作した")
  (println "✗ stddevとvarianceの関係に問題がある"))

; 5.4 大量データ
(println "\n[5.4] stddev - 大量データ")
(def stddev-bulk-pass
  (let [data (range 0 100)
        result (stats/stddev data)]
    (float? result)))

(if stddev-bulk-pass
  (println "✓ stddevの大量データ処理は正しく動作した")
  (println "✗ stddevの大量データ処理に問題がある"))

; ========================================
; Section 6: stats/percentile
; ========================================

(println "\n--- Section 6: stats/percentile ---")

; 6.1 50パーセンタイル（中央値）
(println "\n[6.1] percentile - 50パーセンタイル")
(def percentile-50-pass
  (and
    (= (stats/percentile [1 2 3 4 5] 50) 3.0)
    (= (stats/percentile [1 2 3 4 5] 50) (stats/median [1 2 3 4 5]))))

(if percentile-50-pass
  (println "✓ percentileの50パーセンタイルは正しく動作した")
  (println "✗ percentileの50パーセンタイルに問題がある"))

; 6.2 0と100パーセンタイル
(println "\n[6.2] percentile - 0と100パーセンタイル")
(def percentile-edges-pass
  (and
    (= (stats/percentile [1 2 3 4 5] 0) 1.0)
    (= (stats/percentile [1 2 3 4 5] 100) 5.0)))

(if percentile-edges-pass
  (println "✓ percentileの0と100パーセンタイルは正しく動作した")
  (println "✗ percentileの0と100パーセンタイルに問題がある"))

; 6.3 25と75パーセンタイル
(println "\n[6.3] percentile - 25と75パーセンタイル")
(def percentile-quartiles-pass
  (and
    (= (stats/percentile [1 2 3 4 5] 25) 2.0)
    (= (stats/percentile [1 2 3 4 5] 75) 4.0)))

(if percentile-quartiles-pass
  (println "✓ percentileの25と75パーセンタイルは正しく動作した")
  (println "✗ percentileの25と75パーセンタイルに問題がある"))

; 6.4 95パーセンタイル
(println "\n[6.4] percentile - 95パーセンタイル")
(def percentile-95-pass
  (= (stats/percentile [1 2 3 4 5] 95) 4.8))

(if percentile-95-pass
  (println "✓ percentileの95パーセンタイルは正しく動作した")
  (println "✗ percentileの95パーセンタイルに問題がある"))

; 6.5 大量データ
(println "\n[6.5] percentile - 大量データ")
(def percentile-bulk-pass
  (let [data (range 1 101)
        p50 (stats/percentile data 50)
        p90 (stats/percentile data 90)]
    (and
      (= p50 50.5)
      (= (math/round p90) 90))))

(if percentile-bulk-pass
  (println "✓ percentileの大量データ処理は正しく動作した")
  (println "✗ percentileの大量データ処理に問題がある"))

; ========================================
; Section 7: 統合テスト
; ========================================

(println "\n--- Section 7: 統合テスト ---")

; 7.1 基本統計量の組み合わせ
(println "\n[7.1] 基本統計量の組み合わせ")
(def integration-basic-pass
  (let [data [1 2 3 4 5]
        mean (stats/mean data)
        median (stats/median data)
        var (stats/variance data)
        std (stats/stddev data)]
    (and
      (= mean 3.0)
      (= median 3.0)
      (= var 2.0)
      (= std (math/sqrt 2.0)))))

(if integration-basic-pass
  (println "✓ 基本統計量の組み合わせは正しく動作した")
  (println "✗ 基本統計量の組み合わせに問題がある"))

; 7.2 複数データセットの比較
(println "\n[7.2] 複数データセットの比較")
(def integration-compare-pass
  (let [data1 [1 2 3 4 5]
        data2 [10 20 30 40 50]
        mean1 (stats/mean data1)
        mean2 (stats/mean data2)
        std1 (stats/stddev data1)
        std2 (stats/stddev data2)]
    (and
      (float? mean1)
      (float? mean2)
      (float? std1)
      (float? std2))))

(if integration-compare-pass
  (println "✓ 複数データセットの比較は正しく動作した")
  (println "✗ 複数データセットの比較に問題がある"))

; 7.3 パーセンタイルと中央値の一貫性
(println "\n[7.3] パーセンタイルと中央値の一貫性")
(def integration-percentile-pass
  (let [data [1 2 3 4 5 6 7 8 9 10]
        median (stats/median data)
        p50 (stats/percentile data 50)]
    (= median p50)))

(if integration-percentile-pass
  (println "✓ パーセンタイルと中央値の一貫性は正しく動作した")
  (println "✗ パーセンタイルと中央値の一貫性に問題がある"))

; 7.4 大規模データの統計処理
(println "\n[7.4] 大規模データの統計処理")
(def integration-bulk-pass
  (let [data (range 1 10001)
        mean (stats/mean data)
        median (stats/median data)
        p25 (stats/percentile data 25)
        p75 (stats/percentile data 75)]
    (and
      (= mean 5000.5)
      (= median 5000.5)
      (= p25 2500.75)
      (= p75 7500.25))))

(if integration-bulk-pass
  (println "✓ 大規模データの統計処理は正しく動作した")
  (println "✗ 大規模データの統計処理に問題がある"))

; ========================================
; 最終結果
; ========================================

(println "\n========================================")
(println "統計関数 Torture Test 完了")
(println "========================================")
(println "\n全セクションが実行されました。")
(println "各セクションのチェックマーク (✓/✗) を確認してください。")
