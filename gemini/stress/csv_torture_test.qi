; csv_torture_test.qi
; CSV関数（5個）の torture test
;
; csv/parse, csv/stringify, csv/read-file, csv/write-file, csv/read-stream

(println "========================================")
(println "CSV関数 Torture Test 開始")
(println "========================================")

; ========================================
; Section 1: csv/parse
; ========================================

(println "\n--- Section 1: csv/parse ---")

; 1.1 基本動作
(println "\n[1.1] csv/parse - 基本動作")
(def parse-basic-data (csv/parse "name,age\nAlice,30\nBob,25"))
(def parse-basic-pass
  (and
    (coll? parse-basic-data)
    (= (count parse-basic-data) 3)
    (= (count (first parse-basic-data)) 2)))

(if parse-basic-pass
  (println "✓ csv/parseの基本動作は正しく動作した")
  (println "✗ csv/parseの基本動作に問題がある"))

; 1.2 ヘッダーなし
(println "\n[1.2] csv/parse - ヘッダーなし")
(def parse-no-header-data (csv/parse "1,2,3\n4,5,6"))
(def parse-no-header-pass
  (and
    (coll? parse-no-header-data)
    (= (count parse-no-header-data) 2)))

(if parse-no-header-pass
  (println "✓ csv/parseのヘッダーなしは正しく動作した")
  (println "✗ csv/parseのヘッダーなしに問題がある"))

; 1.3 空フィールド
(println "\n[1.3] csv/parse - 空フィールド")
(def parse-empty-field-data (csv/parse "a,,c\nd,e,"))
(def parse-empty-field-pass (coll? parse-empty-field-data))

(if parse-empty-field-pass
  (println "✓ csv/parseの空フィールドは正しく動作した")
  (println "✗ csv/parseの空フィールドに問題がある"))

; ========================================
; Section 2: csv/stringify
; ========================================

(println "\n--- Section 2: csv/stringify ---")

; 2.1 基本動作
(println "\n[2.1] csv/stringify - 基本動作")
(def stringify-basic-data [["name" "age"] ["Alice" "30"] ["Bob" "25"]])
(def stringify-basic-result (csv/stringify stringify-basic-data))
(def stringify-basic-pass
  (and
    (string? stringify-basic-result)
    (str/contains? stringify-basic-result "name")
    (str/contains? stringify-basic-result "Alice")))

(if stringify-basic-pass
  (println "✓ csv/stringifyの基本動作は正しく動作した")
  (println "✗ csv/stringifyの基本動作に問題がある"))

; 2.2 往復変換
(println "\n[2.2] csv/stringify - 往復変換")
(def stringify-roundtrip-original [["a" "b"] ["1" "2"]])
(def stringify-roundtrip-csv (csv/stringify stringify-roundtrip-original))
(def stringify-roundtrip-parsed (csv/parse stringify-roundtrip-csv))
(def stringify-roundtrip-pass
  (= (count stringify-roundtrip-parsed) (count stringify-roundtrip-original)))

(if stringify-roundtrip-pass
  (println "✓ csv/stringifyの往復変換は正しく動作した")
  (println "✗ csv/stringifyの往復変換に問題がある"))

; ========================================
; Section 3: csv/write-file と csv/read-file
; ========================================

(println "\n--- Section 3: csv/write-file と csv/read-file ---")

; 3.1 ファイル書き込みと読み込み
(println "\n[3.1] csv/write-file と csv/read-file")
(def file-io-test-file "/tmp/qi_csv_test.csv")
(def file-io-test-data [["name" "value"] ["test1" "100"] ["test2" "200"]])
(def file-io-write-result (csv/write-file file-io-test-data file-io-test-file))
(def file-io-read-data (csv/read-file file-io-test-file))
(def file-io-pass (= (count file-io-read-data) (count file-io-test-data)))

(if file-io-pass
  (println "✓ csv/write-fileとcsv/read-fileは正しく動作した")
  (println "✗ csv/write-fileとcsv/read-fileに問題がある"))

; ========================================
; Section 4: csv/read-stream
; ========================================

(println "\n--- Section 4: csv/read-stream ---")

; 4.1 ストリーム読み込み
(println "\n[4.1] csv/read-stream")
(def stream-test-file "/tmp/qi_csv_stream_test.csv")
(def stream-test-data [["a" "b"] ["1" "2"] ["3" "4"]])
(def stream-write-result (csv/write-file stream-test-data stream-test-file))
(def stream-read-result (csv/read-stream stream-test-file))
(def stream-read-pass (not (nil? stream-read-result)))

(if stream-read-pass
  (println "✓ csv/read-streamは正しく動作した")
  (println "✗ csv/read-streamに問題がある"))

; ========================================
; Section 5: 統合テスト
; ========================================

(println "\n--- Section 5: 統合テスト ---")

; 5.1 大量データ
(println "\n[5.1] 大量データの処理")
(def bulk-rows (map (fn [i] [(to-string i) (str "item" i) (to-string (* i 10))]) (range 0 100)))
(def bulk-csv (csv/stringify bulk-rows))
(def bulk-parsed (csv/parse bulk-csv))
(def bulk-pass (= (count bulk-parsed) (count bulk-rows)))

(if bulk-pass
  (println "✓ 大量データの処理は正しく動作した")
  (println "✗ 大量データの処理に問題がある"))

; 5.2 ファイルI/O往復
(println "\n[5.2] ファイルI/O往復")
(def roundtrip-file "/tmp/qi_csv_roundtrip.csv")
(def roundtrip-original [["x" "y"] ["1" "2"] ["3" "4"]])
(def roundtrip-write (csv/write-file roundtrip-original roundtrip-file))
(def roundtrip-read (csv/read-file roundtrip-file))
(def roundtrip-pass (= (count roundtrip-read) (count roundtrip-original)))

(if roundtrip-pass
  (println "✓ ファイルI/O往復は正しく動作した")
  (println "✗ ファイルI/O往復に問題がある"))

; ========================================
; 最終結果
; ========================================

(println "\n========================================")
(println "CSV関数 Torture Test 完了")
(println "========================================")
(println "\n全セクションが実行されました。")
(println "各セクションのチェックマーク (✓/✗) を確認してください。")
