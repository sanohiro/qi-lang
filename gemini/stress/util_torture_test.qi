; util_torture_test.qi
; Util関数（6個）の torture test
;
; to-int, to-float, to-string, now, timestamp, sleep

(println "========================================")
(println "Util関数 Torture Test 開始")
(println "========================================")

; ========================================
; Section 1: to-int
; ========================================

(println "\n--- Section 1: to-int ---")

; 1.1 基本動作
(println "\n[1.1] to-int - 基本動作")
(def to-int-basic-pass
  (and
    (= (to-int "123") 123)
    (= (to-int "0") 0)
    (= (to-int "-42") -42)))

(if to-int-basic-pass
  (println "✓ to-intの基本動作は正しく動作した")
  (println "✗ to-intの基本動作に問題がある"))

; 1.2 浮動小数点からの変換
(println "\n[1.2] to-int - 浮動小数点からの変換")
(def to-int-float-pass
  (and
    (= (to-int 3.14) 3)
    (= (to-int 99.9) 99)
    (= (to-int -2.7) -2)))

(if to-int-float-pass
  (println "✓ to-intの浮動小数点変換は正しく動作した")
  (println "✗ to-intの浮動小数点変換に問題がある"))

; 1.3 大きな数値
(println "\n[1.3] to-int - 大きな数値")
(def to-int-large-pass
  (and
    (= (to-int "1000000") 1000000)
    (= (to-int "-999999") -999999)))

(if to-int-large-pass
  (println "✓ to-intの大きな数値は正しく動作した")
  (println "✗ to-intの大きな数値に問題がある"))

; ========================================
; Section 2: to-float
; ========================================

(println "\n--- Section 2: to-float ---")

; 2.1 基本動作
(println "\n[2.1] to-float - 基本動作")
(def to-float-basic-pass
  (and
    (= (to-float "3.14") 3.14)
    (= (to-float "0.5") 0.5)
    (= (to-float "-2.7") -2.7)))

(if to-float-basic-pass
  (println "✓ to-floatの基本動作は正しく動作した")
  (println "✗ to-floatの基本動作に問題がある"))

; 2.2 整数からの変換
(println "\n[2.2] to-float - 整数からの変換")
(def to-float-int-pass
  (and
    (= (to-float 42) 42.0)
    (= (to-float 0) 0.0)
    (= (to-float -10) -10.0)))

(if to-float-int-pass
  (println "✓ to-floatの整数変換は正しく動作した")
  (println "✗ to-floatの整数変換に問題がある"))

; 2.3 文字列（整数形式）からの変換
(println "\n[2.3] to-float - 文字列（整数形式）")
(def to-float-str-int-pass
  (and
    (= (to-float "100") 100.0)
    (= (to-float "-50") -50.0)))

(if to-float-str-int-pass
  (println "✓ to-floatの文字列（整数）変換は正しく動作した")
  (println "✗ to-floatの文字列（整数）変換に問題がある"))

; ========================================
; Section 3: to-string
; ========================================

(println "\n--- Section 3: to-string ---")

; 3.1 基本動作
(println "\n[3.1] to-string - 基本動作")
(def to-string-basic-pass
  (and
    (= (to-string 42) "42")
    (= (to-string 3.14) "3.14")
    (= (to-string true) "true")
    (= (to-string false) "false")
    (= (to-string nil) "nil")))

(if to-string-basic-pass
  (println "✓ to-stringの基本動作は正しく動作した")
  (println "✗ to-stringの基本動作に問題がある"))

; 3.2 キーワード・シンボル
(println "\n[3.2] to-string - キーワード・シンボル")
(def to-string-keyword-pass
  (and
    (= (to-string :test) "test")
    (string? (to-string 'symbol))))

(if to-string-keyword-pass
  (println "✓ to-stringのキーワード・シンボル変換は正しく動作した")
  (println "✗ to-stringのキーワード・シンボル変換に問題がある"))

; 3.3 コレクション
(println "\n[3.3] to-string - コレクション")
(def to-string-coll-pass
  (and
    (string? (to-string [1 2 3]))
    (string? (to-string {:a 1}))))

(if to-string-coll-pass
  (println "✓ to-stringのコレクション変換は正しく動作した")
  (println "✗ to-stringのコレクション変換に問題がある"))

; ========================================
; Section 4: now
; ========================================

(println "\n--- Section 4: now ---")

; 4.1 基本動作
(println "\n[4.1] now - 基本動作")
(def now-basic-pass
  (let [t1 (now)
        t2 (now)]
    (and
      (integer? t1)
      (integer? t2)
      (>= t2 t1))))

(if now-basic-pass
  (println "✓ nowの基本動作は正しく動作した")
  (println "✗ nowの基本動作に問題がある"))

; 4.2 複数回呼び出し
(println "\n[4.2] now - 複数回呼び出し")
(def now-multiple-pass
  (let [times (map (fn [_] (now)) (range 0 10))]
    (= (count times) 10)))

(if now-multiple-pass
  (println "✓ nowの複数回呼び出しは正しく動作した")
  (println "✗ nowの複数回呼び出しに問題がある"))

; ========================================
; Section 5: timestamp
; ========================================

(println "\n--- Section 5: timestamp ---")

; 5.1 基本動作
(println "\n[5.1] timestamp - 基本動作")
(def timestamp-basic-pass
  (let [t1 (timestamp)
        t2 (timestamp)]
    (and
      (integer? t1)
      (integer? t2)
      (>= t2 t1))))

(if timestamp-basic-pass
  (println "✓ timestampの基本動作は正しく動作した")
  (println "✗ timestampの基本動作に問題がある"))

; 5.2 nowとの一貫性
(println "\n[5.2] timestamp - nowとの一貫性")
(def timestamp-consistency-pass
  (let [t1 (now)
        t2 (timestamp)]
    (and
      (integer? t1)
      (integer? t2))))

(if timestamp-consistency-pass
  (println "✓ timestampとnowの一貫性は正しく動作した")
  (println "✗ timestampとnowの一貫性に問題がある"))

; ========================================
; Section 6: sleep
; ========================================

(println "\n--- Section 6: sleep ---")

; 6.1 基本動作（短時間）
(println "\n[6.1] sleep - 基本動作")
(def sleep-basic-pass
  (let [start (now)
        _ (sleep 100)  ; 100ミリ秒
        end (now)
        diff (- end start)]
    (>= diff 100)))

(if sleep-basic-pass
  (println "✓ sleepの基本動作は正しく動作した")
  (println "✗ sleepの基本動作に問題がある"))

; 6.2 0ミリ秒
(println "\n[6.2] sleep - 0ミリ秒")
(def sleep-zero-pass
  (do
    (sleep 0)
    true))

(if sleep-zero-pass
  (println "✓ sleepの0ミリ秒は正しく動作した")
  (println "✗ sleepの0ミリ秒に問題がある"))

; ========================================
; Section 7: 統合テスト
; ========================================

(println "\n--- Section 7: 統合テスト ---")

; 7.1 型変換の往復
(println "\n[7.1] 型変換の往復")
(def roundtrip-pass
  (and
    (= (to-int (to-string 42)) 42)
    (= (to-float (to-string 3.14)) 3.14)
    (= (to-string (to-int "100")) "100")))

(if roundtrip-pass
  (println "✓ 型変換の往復は正しく動作した")
  (println "✗ 型変換の往復に問題がある"))

; 7.2 時間測定
(println "\n[7.2] 時間測定")
(def time-measurement-pass
  (let [start (now)
        _ (sleep 50)
        end (now)
        elapsed (- end start)]
    (and
      (>= elapsed 50)
      (< elapsed 200))))  ; 余裕を持たせる

(if time-measurement-pass
  (println "✓ 時間測定は正しく動作した")
  (println "✗ 時間測定に問題がある"))

; 7.3 大量の型変換
(println "\n[7.3] 大量の型変換")
(def bulk-conversion-pass
  (let [nums (range 0 100)
        strs (map to-string nums)
        ints (map to-int strs)]
    (and
      (= (count strs) 100)
      (= (count ints) 100)
      (= ints nums))))

(if bulk-conversion-pass
  (println "✓ 大量の型変換は正しく動作した")
  (println "✗ 大量の型変換に問題がある"))

; ========================================
; 最終結果
; ========================================

(println "\n========================================")
(println "Util関数 Torture Test 完了")
(println "========================================")
(println "\n全セクションが実行されました。")
(println "各セクションのチェックマーク (✓/✗) を確認してください。")
