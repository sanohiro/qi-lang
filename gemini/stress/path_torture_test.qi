; path_torture_test.qi
; パス操作関数（9個）の torture test
;
; path/join, path/basename, path/dirname, path/extension, path/stem,
; path/absolute, path/normalize, path/is-absolute?, path/is-relative?

(println "========================================")
(println "パス操作関数 Torture Test 開始")
(println "========================================")

; ========================================
; Section 1: path/join
; ========================================

(println "\n--- Section 1: path/join ---")

; 1.1 基本動作
(println "\n[1.1] join - 基本動作")
(def join-basic-pass
  (and
    (= (path/join "a" "b") "a/b")
    (= (path/join "a" "b" "c") "a/b/c")
    (= (path/join "/root" "sub") "/root/sub")))

(if join-basic-pass
  (println "✓ joinの基本動作は正しく動作した")
  (println "✗ joinの基本動作に問題がある"))

; 1.2 空文字列
(println "\n[1.2] join - 空文字列")
(def join-empty-pass
  (and
    (= (path/join "a" "") "a/")
    (= (path/join "" "b") "b")
    (= (path/join "a" "" "b") "a/b")))

(if join-empty-pass
  (println "✓ joinの空文字列は正しく動作した")
  (println "✗ joinの空文字列に問題がある"))

; 1.3 絶対パスと相対パス
(println "\n[1.3] join - 絶対パスと相対パス")
(def join-abs-rel-pass
  (and
    (= (path/join "/abs" "rel") "/abs/rel")
    (= (path/join "rel" "path") "rel/path")
    (= (path/join "/a" "b" "c") "/a/b/c")))

(if join-abs-rel-pass
  (println "✓ joinの絶対パスと相対パスは正しく動作した")
  (println "✗ joinの絶対パスと相対パスに問題がある"))

; 1.4 大量データ
(println "\n[1.4] join - 大量データ")
(def join-bulk-pass
  (let [parts (map str (range 0 100))
        result (apply path/join parts)]
    (and
      (string? result)
      (> (len result) 0))))

(if join-bulk-pass
  (println "✓ joinの大量データ処理は正しく動作した")
  (println "✗ joinの大量データ処理に問題がある"))

; ========================================
; Section 2: path/basename
; ========================================

(println "\n--- Section 2: path/basename ---")

; 2.1 基本動作
(println "\n[2.1] basename - 基本動作")
(def basename-basic-pass
  (and
    (= (path/basename "/path/to/file.txt") "file.txt")
    (= (path/basename "file.txt") "file.txt")
    (= (path/basename "/path/to/dir/") "dir")))

(if basename-basic-pass
  (println "✓ basenameの基本動作は正しく動作した")
  (println "✗ basenameの基本動作に問題がある"))

; 2.2 拡張子なし
(println "\n[2.2] basename - 拡張子なし")
(def basename-no-ext-pass
  (and
    (= (path/basename "/path/to/file") "file")
    (= (path/basename "file") "file")))

(if basename-no-ext-pass
  (println "✓ basenameの拡張子なしは正しく動作した")
  (println "✗ basenameの拡張子なしに問題がある"))

; 2.3 特殊ケース
(println "\n[2.3] basename - 特殊ケース")
(def basename-special-pass
  (and
    (= (path/basename "/") "")
    (= (path/basename ".") "")
    (= (path/basename "..") "")
    (= (path/basename ".hidden") ".hidden")))

(if basename-special-pass
  (println "✓ basenameの特殊ケースは正しく動作した")
  (println "✗ basenameの特殊ケースに問題がある"))

; 2.4 複数ドット
(println "\n[2.4] basename - 複数ドット")
(def basename-multi-dot-pass
  (and
    (= (path/basename "file.tar.gz") "file.tar.gz")
    (= (path/basename "archive.backup.2024.tar") "archive.backup.2024.tar")))

(if basename-multi-dot-pass
  (println "✓ basenameの複数ドットは正しく動作した")
  (println "✗ basenameの複数ドットに問題がある"))

; ========================================
; Section 3: path/dirname
; ========================================

(println "\n--- Section 3: path/dirname ---")

; 3.1 基本動作
(println "\n[3.1] dirname - 基本動作")
(def dirname-basic-pass
  (and
    (= (path/dirname "/path/to/file.txt") "/path/to")
    (= (path/dirname "/path/to/") "/path")
    (= (path/dirname "file.txt") "")))

(if dirname-basic-pass
  (println "✓ dirnameの基本動作は正しく動作した")
  (println "✗ dirnameの基本動作に問題がある"))

; 3.2 ルートパス
(println "\n[3.2] dirname - ルートパス")
(def dirname-root-pass
  (and
    (= (path/dirname "/") "")
    (= (path/dirname "/file") "/")))

(if dirname-root-pass
  (println "✓ dirnameのルートパスは正しく動作した")
  (println "✗ dirnameのルートパスに問題がある"))

; 3.3 相対パス
(println "\n[3.3] dirname - 相対パス")
(def dirname-relative-pass
  (and
    (= (path/dirname "a/b/c") "a/b")
    (= (path/dirname "a/b") "a")
    (= (path/dirname "a") "")))

(if dirname-relative-pass
  (println "✓ dirnameの相対パスは正しく動作した")
  (println "✗ dirnameの相対パスに問題がある"))

; ========================================
; Section 4: path/extension
; ========================================

(println "\n--- Section 4: path/extension ---")

; 4.1 基本動作
(println "\n[4.1] extension - 基本動作")
(def extension-basic-pass
  (and
    (= (path/extension "file.txt") "txt")
    (= (path/extension "/path/to/file.md") "md")
    (= (path/extension "archive.tar.gz") "gz")))

(if extension-basic-pass
  (println "✓ extensionの基本動作は正しく動作した")
  (println "✗ extensionの基本動作に問題がある"))

; 4.2 拡張子なし
(println "\n[4.2] extension - 拡張子なし")
(def extension-none-pass
  (and
    (= (path/extension "file") "")
    (= (path/extension "/path/to/file") "")
    (= (path/extension "/path/") "")))

(if extension-none-pass
  (println "✓ extensionの拡張子なしは正しく動作した")
  (println "✗ extensionの拡張子なしに問題がある"))

; 4.3 隠しファイル
(println "\n[4.3] extension - 隠しファイル")
(def extension-hidden-pass
  (and
    (= (path/extension ".hidden") "")
    (= (path/extension ".hidden.txt") "txt")))

(if extension-hidden-pass
  (println "✓ extensionの隠しファイルは正しく動作した")
  (println "✗ extensionの隠しファイルに問題がある"))

; ========================================
; Section 5: path/stem
; ========================================

(println "\n--- Section 5: path/stem ---")

; 5.1 基本動作
(println "\n[5.1] stem - 基本動作")
(def stem-basic-pass
  (and
    (= (path/stem "file.txt") "file")
    (= (path/stem "/path/to/document.pdf") "document")
    (= (path/stem "archive.tar.gz") "archive.tar")))

(if stem-basic-pass
  (println "✓ stemの基本動作は正しく動作した")
  (println "✗ stemの基本動作に問題がある"))

; 5.2 拡張子なし
(println "\n[5.2] stem - 拡張子なし")
(def stem-no-ext-pass
  (and
    (= (path/stem "file") "file")
    (= (path/stem "/path/to/readme") "readme")))

(if stem-no-ext-pass
  (println "✓ stemの拡張子なしは正しく動作した")
  (println "✗ stemの拡張子なしに問題がある"))

; 5.3 隠しファイル
(println "\n[5.3] stem - 隠しファイル")
(def stem-hidden-pass
  (and
    (= (path/stem ".hidden") ".hidden")
    (= (path/stem ".config.json") ".config")))

(if stem-hidden-pass
  (println "✓ stemの隠しファイルは正しく動作した")
  (println "✗ stemの隠しファイルに問題がある"))

; ========================================
; Section 6: path/absolute
; ========================================

(println "\n--- Section 6: path/absolute ---")

; 6.1 絶対パス（そのまま返る）
(println "\n[6.1] absolute - 絶対パス")
(def absolute-abs-pass
  (and
    (= (path/absolute "/usr/bin") "/usr/bin")
    (= (path/absolute "/") "/")))

(if absolute-abs-pass
  (println "✓ absoluteの絶対パスは正しく動作した")
  (println "✗ absoluteの絶対パスに問題がある"))

; 6.2 相対パス（現在のディレクトリに展開）
(println "\n[6.2] absolute - 相対パス")
(def absolute-rel-pass
  (let [result (path/absolute "file.txt")]
    (and
      (string? result)
      (> (len result) (len "file.txt")))))

(if absolute-rel-pass
  (println "✓ absoluteの相対パスは正しく動作した")
  (println "✗ absoluteの相対パスに問題がある"))

; 6.3 カレントディレクトリ
(println "\n[6.3] absolute - カレントディレクトリ")
(def absolute-current-pass
  (let [result (path/absolute ".")]
    (and
      (string? result)
      (> (len result) 0))))

(if absolute-current-pass
  (println "✓ absoluteのカレントディレクトリは正しく動作した")
  (println "✗ absoluteのカレントディレクトリに問題がある"))

; ========================================
; Section 7: path/normalize
; ========================================

(println "\n--- Section 7: path/normalize ---")

; 7.1 基本動作（.の解決）
(println "\n[7.1] normalize - 基本動作")
(def normalize-basic-pass
  (and
    (= (path/normalize "a/./b") "a/b")
    (= (path/normalize "./a/b") "a/b")
    (= (path/normalize "a/b/.") "a/b")))

(if normalize-basic-pass
  (println "✓ normalizeの基本動作は正しく動作した")
  (println "✗ normalizeの基本動作に問題がある"))

; 7.2 ..の解決
(println "\n[7.2] normalize - ..の解決")
(def normalize-parent-pass
  (and
    (= (path/normalize "a/b/../c") "a/c")
    (= (path/normalize "a/../b") "b")
    (= (path/normalize "a/b/../../c") "c")))

(if normalize-parent-pass
  (println "✓ normalizeの..解決は正しく動作した")
  (println "✗ normalizeの..解決に問題がある"))

; 7.3 複雑なパス
(println "\n[7.3] normalize - 複雑なパス")
(def normalize-complex-pass
  (and
    (= (path/normalize "a/./b/../c/./d") "a/c/d")
    (= (path/normalize "./a/b/.././c") "a/c")))

(if normalize-complex-pass
  (println "✓ normalizeの複雑なパスは正しく動作した")
  (println "✗ normalizeの複雑なパスに問題がある"))

; 7.4 絶対パスの正規化
(println "\n[7.4] normalize - 絶対パス")
(def normalize-absolute-pass
  (and
    (= (path/normalize "/a/./b") "/a/b")
    (= (path/normalize "/a/b/../c") "/a/c")))

(if normalize-absolute-pass
  (println "✓ normalizeの絶対パスは正しく動作した")
  (println "✗ normalizeの絶対パスに問題がある"))

; ========================================
; Section 8: path/is-absolute?
; ========================================

(println "\n--- Section 8: path/is-absolute? ---")

; 8.1 絶対パス
(println "\n[8.1] is-absolute? - 絶対パス")
(def is-absolute-true-pass
  (and
    (= (path/is-absolute? "/usr/bin") true)
    (= (path/is-absolute? "/") true)
    (= (path/is-absolute? "/a/b/c") true)))

(if is-absolute-true-pass
  (println "✓ is-absolute?の絶対パスは正しく動作した")
  (println "✗ is-absolute?の絶対パスに問題がある"))

; 8.2 相対パス
(println "\n[8.2] is-absolute? - 相対パス")
(def is-absolute-false-pass
  (and
    (= (path/is-absolute? "file.txt") false)
    (= (path/is-absolute? "./file") false)
    (= (path/is-absolute? "../file") false)
    (= (path/is-absolute? "a/b/c") false)))

(if is-absolute-false-pass
  (println "✓ is-absolute?の相対パスは正しく動作した")
  (println "✗ is-absolute?の相対パスに問題がある"))

; ========================================
; Section 9: path/is-relative?
; ========================================

(println "\n--- Section 9: path/is-relative? ---")

; 9.1 相対パス
(println "\n[9.1] is-relative? - 相対パス")
(def is-relative-true-pass
  (and
    (= (path/is-relative? "file.txt") true)
    (= (path/is-relative? "./file") true)
    (= (path/is-relative? "../file") true)
    (= (path/is-relative? "a/b/c") true)))

(if is-relative-true-pass
  (println "✓ is-relative?の相対パスは正しく動作した")
  (println "✗ is-relative?の相対パスに問題がある"))

; 9.2 絶対パス
(println "\n[9.2] is-relative? - 絶対パス")
(def is-relative-false-pass
  (and
    (= (path/is-relative? "/usr/bin") false)
    (= (path/is-relative? "/") false)
    (= (path/is-relative? "/a/b/c") false)))

(if is-relative-false-pass
  (println "✓ is-relative?の絶対パスは正しく動作した")
  (println "✗ is-relative?の絶対パスに問題がある"))

; ========================================
; Section 10: 統合テスト
; ========================================

(println "\n--- Section 10: 統合テスト ---")

; 10.1 パス操作の組み合わせ
(println "\n[10.1] パス操作の組み合わせ")
(def integration-pass
  (let [joined (path/join "/home" "user" "file.txt")
        dir (path/dirname joined)
        base (path/basename joined)
        ext (path/extension joined)
        stem (path/stem joined)]
    (and
      (= joined "/home/user/file.txt")
      (= dir "/home/user")
      (= base "file.txt")
      (= ext "txt")
      (= stem "file"))))

(if integration-pass
  (println "✓ パス操作の組み合わせは正しく動作した")
  (println "✗ パス操作の組み合わせに問題がある"))

; 10.2 正規化と絶対パス判定
(println "\n[10.2] 正規化と絶対パス判定")
(def normalize-check-pass
  (let [normalized (path/normalize "/a/./b/../c")]
    (and
      (= normalized "/a/c")
      (= (path/is-absolute? normalized) true)
      (= (path/is-relative? normalized) false))))

(if normalize-check-pass
  (println "✓ 正規化と絶対パス判定は正しく動作した")
  (println "✗ 正規化と絶対パス判定に問題がある"))

; 10.3 大量パス処理
(println "\n[10.3] 大量パス処理")
(def bulk-path-pass
  (let [paths (map (fn [i] (path/join "/data" (str "file" i ".txt"))) (range 0 100))
        basenames (map path/basename paths)
        extensions (map path/extension paths)]
    (and
      (= (len paths) 100)
      (= (len basenames) 100)
      (= (len extensions) 100)
      (list/every? (fn [e] (= e "txt")) extensions))))

(if bulk-path-pass
  (println "✓ 大量パス処理は正しく動作した")
  (println "✗ 大量パス処理に問題がある"))

; ========================================
; 最終結果
; ========================================

(println "\n========================================")
(println "パス操作関数 Torture Test 完了")
(println "========================================")
(println "\n全セクションが実行されました。")
(println "各セクションのチェックマーク (✓/✗) を確認してください。")
