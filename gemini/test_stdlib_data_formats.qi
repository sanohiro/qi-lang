; test_stdlib_data_formats.qi
; このファイルはQi言語のデータフォーマット標準ライブラリ (json/, yaml/, csv/) のテストです。
; 意図: 各種データフォーマットのパースと生成が正しく行えることを確認します。

(use json)
(use yaml)
(use csv)

(test/run "JSON Parsing and Stringifying" (fn []
  ; 意図: JSONのパース、生成、整形が正しく機能するか。
  (def json-str "{\"name\":\"Alice\",\"age\":30,\"is_active\":true,\"tags\":[\"dev\",\"qi\"]}")
  (def qi-data {:name "Alice" :age 30 :is_active true :tags ["dev" "qi"]})

  ; Parse
  (match (parse json-str)
    {:ok data} -> (test/assert-eq qi-data data)
    {:error e} -> (test/assert false (str "JSON parse failed: " e)))

  ; Stringify (compact)
  (match (stringify qi-data)
    {:ok s} -> (test/assert-eq "{\"name\":\"Alice\",\"age\":30,\"is_active\":true,\"tags\":[\"dev\",\"qi\"]}" s)
    {:error e} -> (test/assert false (str "JSON stringify failed: " e)))

  ; Pretty
  (match (pretty qi-data)
    {:ok s} -> (test/assert (str/starts-with? s "{\n"))
    {:error e} -> (test/assert false (str "JSON pretty failed: " e)))

  ; Invalid JSON
  (test/assert (get (parse "{invalid") :error))
))

(test/run "YAML Parsing and Stringifying" (fn []
  ; 意図: YAMLのパースと生成が正しく機能するか。
  (def yaml-str "name: Alice\nage: 30\nis_active: true\ntags:\n  - dev\n  - qi\n")
  (def qi-data {:name "Alice" :age 30 :is_active true :tags ["dev" "qi"]})

  ; Parse
  (match (yaml/parse yaml-str)
    {:ok data} -> (test/assert-eq qi-data data)
    {:error e} -> (test/assert false (str "YAML parse failed: " e)))

  ; Stringify
  (match (yaml/stringify qi-data)
    {:ok s} -> (test/assert (str/contains? s "name: Alice"))
    {:error e} -> (test/assert false (str "YAML stringify failed: " e)))

  ; Round-trip
  (match (qi-data |> yaml/stringify |>? yaml/parse)
    {:ok data} -> (test/assert-eq qi-data data)
    _ -> (test/assert false "YAML round-trip failed"))
))

(test/run "CSV Parsing and Stringifying" (fn []
  ; 意図: CSVのパースと生成が正しく機能するか。
  (def csv-str "name,age\nAlice,30\nBob,25\n")
  (def qi-data [["name" "age"] ["Alice" "30"] ["Bob" "25"]])

  ; Parse
  (match (csv/parse csv-str)
    {:ok data} -> (test/assert-eq qi-data data)
    {:error e} -> (test/assert false (str "CSV parse failed: " e)))

  ; Stringify
  (match (csv/stringify qi-data)
    {:ok s} -> (test/assert-eq "name,age\nAlice,30\nBob,25\n" s)
    {:error e} -> (test/assert false (str "CSV stringify failed: " e)))

  ; Round-trip with different delimiters
  (def tsv-data [["a" "b"] ["1" "2"]])
  (match (csv/stringify tsv-data {"delimiter" "\t"})
    {:ok tsv-str} -> {
      (test/assert-eq "a\tb\n1\t2\n" tsv-str)
      (match (csv/parse tsv-str {"delimiter" "\t"})
        {:ok parsed} -> (test/assert-eq tsv-data parsed)
        _ -> (test/assert false "TSV parse failed")
      )
    }
    _ -> (test/assert false "TSV stringify failed")
  )
))